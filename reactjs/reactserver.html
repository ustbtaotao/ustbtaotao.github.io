<!DOCTYPE html>
<!--[if lte IE 8 ]>
<html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<!--
***************  *      *     *
      8          *    *       *
      8          *  *         *
      8          **           *
      8          *  *         *
      8          *    *       *
      8          *      *     *
      8          *        *   ***********    -----Theme By Kieran(http://go.kieran.top)
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<!--<![endif]-->

<head>
    <title>
        
        react实现服务器渲染 |
        
        i咖啡</title>
    <!-- Meta data -->
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="generator" content="i咖啡">
    <meta name="author" content="ustbtaotao">
    
    <meta name="keywords" content="reactjs,服务器渲染,react+redux+router+webpack">
    
    
    <meta name="description" content="react实现服务器渲染,react + redux + node + mongodb">
    
    <meta name="wumiiVerification" content="7ae830d3-0185-462c-9371-29173dc04418"/>
    <meta name="baidu_union_verify" content="325fd53fb77cfb471e02dc44b9106274">
    <!-- Favicon, (keep icon in root folder) -->
    <link rel="Shortcut Icon" href="/img/favicon.ico" type="image/ico">

    <link rel="alternate" href=" /atom.xml "
          title="i咖啡" type="application/atom+xml">
    <link rel="stylesheet" href="/css/all.css" media="screen" type="text/css">
    
    <link rel="stylesheet" href="/highlightjs/vs.css" type="text/css">
    

    <!--[if IE 8]>
    <link rel="stylesheet" type="text/css" href="/css/ie8.css"/>
    <![endif]-->

    <!-- jQuery | Load our jQuery, with an alternative source fallback to a local version if request is unavailable -->
    <script src="/js/jquery-1.11.1.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-1.11.1.min.js"><\/script>')</script>

    <!-- Load these in the <head> for quicker IE8+ load times -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/js/html5shiv.min.js"></script>
    <script src="/js/respond.min.js"></script>
    <script src="/js/search.js"></script>
    <![endif]-->

    
    
    
    <style>.col-md-8.col-md-offset-2.opening-statement img {
            display: none;
        }</style>
</head>

<!--
<body class="post-template">
-->
<body id="index" class="lightnav animsition">

<!-- ============================ Off-canvas navigation =========================== -->

<div class="sb-slidebar sb-right sb-style-overlay sb-momentum-scrolling" xmlns="http://www.w3.org/1999/html"
 style="background-color: rgba(21, 21, 21, 0.88);"
>
    <div class="sb-close" aria-label="Close Menu" aria-hidden="true">
        <img src="/img/close.png" alt="Close"/>
    </div>
    <!-- Lists in Slidebars -->
    <ul class="sb-menu">
        <li><a href="/" class="animsition-link" title="Home">Home</a></li>
        <li><a href="/archives" class="animsition-link" title="archive">所有文章</a>
        </li>
        <!-- Dropdown Menu -->
        
        
        <li>
            <a class="sb-toggle-submenu">按分类<span class="sb-caret"></span></a>
            <ul class="sb-submenu">
                
                <li><a href="/categories/electron/" class="animsition-link">electron
                        <small>(1)</small>
                    </a></li>
                
                <li><a href="/categories/git/" class="animsition-link">git
                        <small>(1)</small>
                    </a></li>
                
                <li><a href="/categories/hexo/" class="animsition-link">hexo
                        <small>(7)</small>
                    </a></li>
                
                <li><a href="/categories/html/" class="animsition-link">html
                        <small>(3)</small>
                    </a></li>
                
                <li><a href="/categories/javascript/" class="animsition-link">javascript
                        <small>(6)</small>
                    </a></li>
                
                <li><a href="/categories/kettle/" class="animsition-link">kettle
                        <small>(4)</small>
                    </a></li>
                
                <li><a href="/categories/linux/" class="animsition-link">linux
                        <small>(2)</small>
                    </a></li>
                
                <li><a href="/categories/mongo/" class="animsition-link">mongo
                        <small>(10)</small>
                    </a></li>
                
                <li><a href="/categories/nodejs/" class="animsition-link">nodejs
                        <small>(18)</small>
                    </a></li>
                
                <li><a href="/categories/reactjs/" class="animsition-link">reactjs
                        <small>(26)</small>
                    </a></li>
                
                <li><a href="/categories/svn/" class="animsition-link">svn
                        <small>(1)</small>
                    </a></li>
                
                <li><a href="/categories/other/" class="animsition-link">其他
                        <small>(1)</small>
                    </a></li>
                
                <li><a href="/categories/baby/" class="animsition-link">小小接班人
                        <small>(1)</small>
                    </a></li>
                
                <li><a href="/categories/server/" class="animsition-link">服务
                        <small>(1)</small>
                    </a></li>
                
            </ul>
        </li>
        
        
        <li>
            <a class="sb-toggle-submenu" id="tabs">按标签<span class="sb-caret"></span></a>
            <ul class="sb-submenu">
                
                <li><a href="/tags/reactjs/" class="animsition-link">reactjs
                        <small>(27)</small>
                    </a></li>
                
                <li><a href="/tags/component/" class="animsition-link">组件
                        <small>(5)</small>
                    </a></li>
                
                <li><a href="/tags/electron/" class="animsition-link">electron
                        <small>(1)</small>
                    </a></li>
                
                <li><a href="/tags/hexo/" class="animsition-link">hexo
                        <small>(7)</small>
                    </a></li>
                
                <li><a href="/tags/other/" class="animsition-link">其他
                        <small>(3)</small>
                    </a></li>
                
                <li><a href="/tags/git/" class="animsition-link">git
                        <small>(1)</small>
                    </a></li>
                
                <li><a href="/tags/html/" class="animsition-link">html
                        <small>(3)</small>
                    </a></li>
                
                <li><a href="/tags/javascript/" class="animsition-link">javascript
                        <small>(22)</small>
                    </a></li>
                
                <li><a href="/tags/kettle/" class="animsition-link">kettle
                        <small>(4)</small>
                    </a></li>
                
                <li><a href="/tags/linux/" class="animsition-link">linux
                        <small>(2)</small>
                    </a></li>
                
                <li><a href="/tags/mongo/" class="animsition-link">mongo
                        <small>(10)</small>
                    </a></li>
                
                <li><a href="/tags/nodejs/" class="animsition-link">nodejs
                        <small>(19)</small>
                    </a></li>
                
                <li><a href="/tags/highchart/" class="animsition-link">highchart
                        <small>(3)</small>
                    </a></li>
                
                <li><a href="/tags/jquery/" class="animsition-link">jquery
                        <small>(1)</small>
                    </a></li>
                
                <li><a href="/tags/webpack/" class="animsition-link">webpack
                        <small>(2)</small>
                    </a></li>
                
                <li><a href="/tags/svn/" class="animsition-link">svn
                        <small>(2)</small>
                    </a></li>
                
                <li><a href="/tags/server/" class="animsition-link">服务
                        <small>(1)</small>
                    </a></li>
                
                <li><a href="/tags/es6/" class="animsition-link">es6
                        <small>(1)</small>
                    </a></li>
                
                <li><a href="/tags/baby/" class="animsition-link">小小接班人
                        <small>(1)</small>
                    </a></li>
                
            </ul>
        </li>
        
        
        <li>
            <a class="sb-toggle-submenu">友情链接<span class="sb-caret"></span></a>
            <ul class="sb-submenu">
                
                <li><a href="http://tool.chinaz.com/" target="_blank" >站长工具</a></li>
                
                <li><a href="http://www.weishao.com.cn/" target="_blank" >锐捷网络_微哨</a></li>
                
                <li><a href=" http://www.pangshunlong.com/" target="_blank" >庞顺龙的博客</a></li>
                
            </ul>
        </li>
        
    </ul>
    <!-- Lists in Slidebars -->
    <ul class="sb-menu secondary">
        <li><a href="http://www.icafebolger.comabout.html" class="animsition-link" title="about">About</a></li>
        <li style="display: none;"><a href="/atom.xml" class="animsition-link" title="rss">RSS</a></li>
    </ul>
</div>

<!-- ============================ END Off-canvas navigation =========================== -->

<!-- ============================ #sb-site Main Page Wrapper =========================== -->

<div id="sb-site">
    <!-- #sb-site - All page content should be contained within this id, except the off-canvas navigation itself -->

    <!-- ============================ Header & Logo bar =========================== -->

    <div id="navigation" class="navbar navbar-fixed-top">
        <div id="site_search" class="sitesearch">
            <div class="form-group">
                <input type="text" id="local-search-input" name="q" results="0" placeholder="search"
                       class="st-search-input st-default-search-input form-control"/>
            </div>
            <div id="local-search-result" class="searchresult"></div>
        </div>
        <div class="navbar-inner" style="background-color: #e8acac;">
            <div class="container">
                <!-- Nav logo -->
                <div class="logo">
                    <a href="/" title="Logo" class="animsition-link">
                        
                        <img src="/img/logo.png" alt="Logo" width="35px;"/>
                        
                    </a>
                </div>
                <!-- // Nav logo -->
                <!-- Info-bar -->
                <nav>
                    <ul class="nav">
                        <li><a href="/" class="animsition-link" style="color: #ffffff;">i咖啡</a></li>
                        
                        
                        <li><a href="http://weibo.com/ustbtaotao" title="Sina-Weibo" target="_blank" style="color: #ffffff;"><i
                                        class="icon-sina-weibo" style="color: #ffffff;"></i>微博</a></li>
                        
                        <li class="nolink" style="color: #ffffff;"><span>Welcome!</span></li>
                    </ul>
                </nav>
                <!--// Info-bar -->
            </div>
            <!-- // .container -->
            <div class="learnmore sb-toggle-right" style="display: none;">More</div>
            <button type="button" class="navbar-toggle menu-icon sb-toggle-right" title="More">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar before"></span>
                <span class="icon-bar main"></span>
                <span class="icon-bar after"></span>
            </button>
        </div>
        <!-- // .navbar-inner -->
    </div>

    <!-- ============================ Header & Logo bar =========================== -->



<section id="intro">
    <div class="container">
        <div class="row col-md-offset-2">
            <div class="col-md-8">
                <span class="post-meta">
      <time datetime="2018-03-07T07:08:43.000Z" itemprop="datePublished">
          2018-03-07
      </time>
    
    
    
    | 
    <a href='/tags/reactjs/'>reactjs</a>
    
    
    <br />
    字数:<span class="post-count">7,298</span>
</span>
                阅读数:
                <span id="/reactjs/reactserver.html" data_time="Wed Mar 07 2018 15:08:43 GMT+0800" class="leancloud_visitors" data-flag-title="react实现服务器渲染"></span>次
                
                <h1>react实现服务器渲染</h1>
            </div>
        </div>
        <div class="col-md-8 col-md-offset-2">
            <div class="bshare-custom" style="float: right;">
                <div class="bsPromo bsPromo2"></div>
                <a title="分享到微信" class="bshare-weixin" href="javascript:void(0);"></a>
                <a title="分享到新浪微博" class="bshare-sinaminiblog" href="javascript:void(0);"></a>
                <a title="分享到QQ空间" class="bshare-qzone"></a>
                <a title="分享到人人网" class="bshare-renren"></a>
                <a title="分享到腾讯微博" class="bshare-qqmb"></a>
                <a title="更多平台" class="bshare-more bshare-more-icon more-style-addthis"></a>
                <span class="BSHARE_COUNT bshare-share-count" style="float: none;">0</span></div>
            <div style="margin-top: 10px;" id="content">
                <h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>之前我们所有的react spa项目都是前后端分离的客户端渲染，即通过render的方式进行UI呈现，通过ajax或者fetch进行api异步请求数据。  闲暇期间接触到了react服务器渲染方式，决定研究研究。为什么要说服务器端渲染呢？查了些帖子和资料，无非以下几个原因：<br>1、代码复用；<br>2、利于SEO，因为整个html都是由node后台生成好直接输出到前端的。<br>3、提升首屏加载速度</p>
<p>为了更好更快的学习，这里给大家分享一个项目，步骤说明已经很清楚了，我不再赘述，这里分享出项目的<a href="https://pan.baidu.com/s/1d9n6SJiDhXsxMwKfLnvKUA" target="_blank" rel="noopener">源码</a>。运行前先建立mongo数据库，建立open_cook库，新建user和recipe表，结构参见src/server/models;mongoose配置修改src/server/config/index.js database节点<br>下载后直接npm install 然后npm run start 即可。具体实现逻辑看下边－－－－－&gt;&gt;&gt;&gt;</p>
<h2 id="分享"><a href="#分享" class="headerlink" title="分享"></a>分享</h2><p>用 React + Redux + Node（Isomorphic JavaScript）开发食谱分享网站</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>如果你是从一开始跟著我们踏出 React 旅程的读者真的恭喜你，也谢谢你一路跟著我们的学习脚步，对一个初学者来说这一段路并不容易。本章是扣除附录外我们最后一个正式章节的范例，也是规模最大的一个，在这个章节中我们要整合过去所学和添加一些知识开发一个可以登入会员并分享食谱的社群网站，Les’s GO！</p>
<h2 id="需求规划"><a href="#需求规划" class="headerlink" title="需求规划"></a>需求规划</h2><p>让使用者可以登入会员并分享食谱的社群网站</p>
<h2 id="功能规划"><a href="#功能规划" class="headerlink" title="功能规划"></a>功能规划</h2><ol>
<li>React Router / Redux / Immutable / Server Render / Async API</li>
<li>使用者登入/登出（JSON Web Token）</li>
<li>CRUD 表单资料处理</li>
<li>资料库串接(ORM/MongoDB)</li>
</ol>
<h2 id="使用技术"><a href="#使用技术" class="headerlink" title="使用技术"></a>使用技术</h2><ol>
<li>React</li>
<li>Redux(redux-actions/redux-promise/redux-immutable)</li>
<li>React Router</li>
<li>ImmutableJS</li>
<li>Node MongoDB ORM(Mongoose)</li>
<li>JSON Web Token</li>
<li>React Bootstrap</li>
<li>Axios(Promise)</li>
<li>Webpack</li>
<li>UUID</li>
</ol>
<h2 id="专案成果截图"><a href="#专案成果截图" class="headerlink" title="专案成果截图"></a>专案成果截图</h2><p><img src="/image/react/open-cook-demo-1.png" alt="用 React + Redux + Node（Isomorphic）开发一个食谱分享网站" title="用 React + Redux + Node（Isomorphic）开发一个食谱分享网站"></p>
<p><img src="/image/react/open-cook-demo-2.png" alt="用 React + Redux + Node（Isomorphic）开发一个食谱分享网站" title="用 React + Redux + Node（Isomorphic）开发一个食谱分享网站"></p>
<p><img src="/image/react/open-cook-demo-3.png" alt="用 React + Redux + Node（Isomorphic）开发一个食谱分享网站" title="用 React + Redux + Node（Isomorphic）开发一个食谱分享网站"></p>
<p><img src="/image/react/open-cook-demo-4.png" alt="用 React + Redux + Node（Isomorphic）开发一个食谱分享网站" title="用 React + Redux + Node（Isomorphic）开发一个食谱分享网站"></p>
<h2 id="环境安装与设定"><a href="#环境安装与设定" class="headerlink" title="环境安装与设定"></a>环境安装与设定</h2><ol>
<li><p>安装 Node 和 NPM</p>
</li>
<li><p>安装所需套件</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install --save react react-dom redux react-redux react-router immutable redux-immutable redux-actions redux-promise bcrypt body-parser cookie-parser debug express immutable jsonwebtoken mongoose morgan passport passport-local react-router-bootstrap axios serve-favicon validator uuid</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install --save-dev babel-core babel-eslint babel-loader babel-preset-es2015 babel-preset-react babel-preset-stage-1 eslint eslint-config-airbnb eslint-loader eslint-plugin-import eslint-plugin-jsx-a11y eslint-plugin-react html-webpack-plugin webpack webpack-dev-server redux-logger</span><br></pre></td></tr></table></figure>
<p>接下来我们先设定一下开发文档。</p>
<ol>
<li><p>设定 Babel 的设定档： <code>.babelrc</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"presets"</span>: [</span><br><span class="line">    <span class="string">"es2015"</span>,</span><br><span class="line">    <span class="string">"react"</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"plugins"</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>设定 ESLint 的设定档和规则： <code>.eslintrc</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"extends"</span>: <span class="string">"airbnb"</span>,</span><br><span class="line">  <span class="string">"rules"</span>: &#123;</span><br><span class="line">    <span class="string">"react/jsx-filename-extension"</span>: [<span class="number">1</span>, &#123; <span class="string">"extensions"</span>: [<span class="string">".js"</span>, <span class="string">".jsx"</span>] &#125;],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"env"</span> :&#123;</span><br><span class="line">    <span class="string">"browser"</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>设定 Webpack 设定档： <code>webpack.config.js</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> webpack <span class="keyword">from</span> <span class="string">'webpack'</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  entry: [</span><br><span class="line">    <span class="string">'./src/client/index.js'</span>,</span><br><span class="line">  ],</span><br><span class="line">  output: &#123;</span><br><span class="line">    path: <span class="string">`<span class="subst">$&#123;__dirname&#125;</span>/dist`</span>,</span><br><span class="line">    filename: <span class="string">'bundle.js'</span>,</span><br><span class="line">    publicPath: <span class="string">'/static/'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    preLoaders: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.jsx$|\.js$/</span>,</span><br><span class="line">        loader: <span class="string">'eslint-loader'</span>,</span><br><span class="line">        include: <span class="string">`<span class="subst">$&#123;__dirname&#125;</span>/app`</span>,</span><br><span class="line">        exclude: <span class="regexp">/bundle\.js$/</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">    <span class="comment">// 使用 Hot Module Replacement 外挂</span></span><br><span class="line">    plugins: [</span><br><span class="line">      <span class="keyword">new</span> webpack.optimize.OccurrenceOrderPlugin(),</span><br><span class="line">      <span class="keyword">new</span> webpack.HotModuleReplacementPlugin()</span><br><span class="line">    ],    </span><br><span class="line">    loaders: [&#123;</span><br><span class="line">      test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">      exclude: <span class="regexp">/node_modules/</span>,</span><br><span class="line">      loader: <span class="string">'babel-loader'</span>,</span><br><span class="line">      query: &#123;</span><br><span class="line">        presets: [<span class="string">'es2015'</span>, <span class="string">'react'</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>设定 <code>src/server/config/index.js</code>：</p>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (&#123;</span><br><span class="line">  <span class="string">"secret"</span>: <span class="string">"ilovecooking"</span>,</span><br><span class="line">  <span class="string">"database"</span>: <span class="string">"mongodb://localhost/open_cook"</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="string">``</span><span class="string">` </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">太好了！这样我们就完成了开发环境的设定可以开始动手实作我们的食谱分享社群应用程式了！  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">同时我们也初步设计我们资料夹结构，主要我们将资料夹分为 `</span>client<span class="string">`、`</span>common<span class="string">`、`</span>server<span class="string">`：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">![用 React + Redux + Node（Isomorphic）开发一个食谱分享网站](./images/open-cook-demo-folder.png "用 React + Redux + Node（Isomorphic）开发一个食谱分享网站")</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 动手实作</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">首先我们先进行 `</span>src/client/index.js<span class="string">` 的设计：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>javascript</span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Provider &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; browserHistory, Router &#125; <span class="keyword">from</span> <span class="string">'react-router'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; fromJS &#125; <span class="keyword">from</span> <span class="string">'immutable'</span>;</span><br><span class="line"><span class="comment">// 我们的 routing 放置在 common 资料夹中的 routes</span></span><br><span class="line"><span class="keyword">import</span> routes <span class="keyword">from</span> <span class="string">'../common/routes'</span>;</span><br><span class="line"><span class="keyword">import</span> configureStore <span class="keyword">from</span> <span class="string">'../common/store/configureStore'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; checkAuth &#125; <span class="keyword">from</span> <span class="string">'../common/actions'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 server side 传过来的 initialState 给 rehydration（覆水）</span></span><br><span class="line"><span class="keyword">const</span> initialState = <span class="built_in">window</span>.__PRELOADED_STATE__;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 initialState 传给 configureStore 函数创建出 store 并传给 Provider</span></span><br><span class="line"><span class="keyword">const</span> store = configureStore(fromJS(initialState));</span><br><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;Provider store=&#123;store&#125;&gt;</span><br><span class="line">    &lt;Router history=&#123;browserHistory&#125; routes=&#123;routes&#125; /&gt;</span><br><span class="line">  &lt;<span class="regexp">/Provider&gt;,</span></span><br><span class="line"><span class="regexp">  document.getElementById('app')</span></span><br><span class="line"><span class="regexp">);</span></span><br></pre></td></tr></table></figure>
<p>由于 Node 端要到新版对于 ES6 支援较好，所以先用 <code>babel-register</code> 在 <code>src/server/index.js</code> 去即时转译 <code>server.js</code>，但不建议在 <code>production</code> 环境使用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// use babel-register to precompile ES6 </span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'babel-register'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'./server'</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入 Express、mongoose（MongoDB ORM）以及相关 server 上使用的套件</span></span><br><span class="line"><span class="comment">/* Server Packages */</span></span><br><span class="line"><span class="keyword">import</span> Express <span class="keyword">from</span> <span class="string">'express'</span>;</span><br><span class="line"><span class="keyword">import</span> bodyParser <span class="keyword">from</span> <span class="string">'body-parser'</span>;</span><br><span class="line"><span class="keyword">import</span> cookieParser <span class="keyword">from</span> <span class="string">'cookie-parser'</span>;</span><br><span class="line"><span class="keyword">import</span> morgan <span class="keyword">from</span> <span class="string">'morgan'</span>;</span><br><span class="line"><span class="keyword">import</span> mongoose <span class="keyword">from</span> <span class="string">'mongoose'</span>;</span><br><span class="line"><span class="keyword">import</span> config <span class="keyword">from</span> <span class="string">'./config'</span>;</span><br><span class="line"><span class="comment">// 引入后端 model 透过 model 和资料库互动 </span></span><br><span class="line"><span class="keyword">import</span> User <span class="keyword">from</span> <span class="string">'./models/user'</span>;</span><br><span class="line"><span class="keyword">import</span> Recipe <span class="keyword">from</span> <span class="string">'./models/recipe'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入 webpackDevMiddleware 当做前端 server middleware</span></span><br><span class="line"><span class="comment">/* Client Packages */</span></span><br><span class="line"><span class="keyword">import</span> webpack <span class="keyword">from</span> <span class="string">'webpack'</span>;</span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> webpackDevMiddleware <span class="keyword">from</span> <span class="string">'webpack-dev-middleware'</span>;</span><br><span class="line"><span class="keyword">import</span> webpackHotMiddleware <span class="keyword">from</span> <span class="string">'webpack-hot-middleware'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; RouterContext, match &#125; <span class="keyword">from</span> <span class="string">'react-router'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; renderToString &#125; <span class="keyword">from</span> <span class="string">'react-dom/server'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Provider &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"><span class="keyword">import</span> Immutable, &#123; fromJS &#125; <span class="keyword">from</span> <span class="string">'immutable'</span>;</span><br><span class="line"><span class="comment">/* Common Packages */</span></span><br><span class="line"><span class="keyword">import</span> webpackConfig <span class="keyword">from</span> <span class="string">'../../webpack.config'</span>;</span><br><span class="line"><span class="keyword">import</span> routes <span class="keyword">from</span> <span class="string">'../common/routes'</span>;</span><br><span class="line"><span class="keyword">import</span> configureStore <span class="keyword">from</span> <span class="string">'../common/store/configureStore'</span>;</span><br><span class="line"><span class="keyword">import</span> fetchComponentData <span class="keyword">from</span> <span class="string">'../common/utils/fetchComponentData'</span>;</span><br><span class="line"><span class="keyword">import</span> apiRoutes <span class="keyword">from</span> <span class="string">'./controllers/api.js'</span>;</span><br><span class="line"><span class="comment">/* config */</span></span><br><span class="line"><span class="comment">// 初始化 Express server</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Express();</span><br><span class="line"><span class="keyword">const</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line"><span class="comment">// 连接到资料库，相关设定档案放在 config.database</span></span><br><span class="line">mongoose.connect(config.database); <span class="comment">// connect to database</span></span><br><span class="line">app.set(<span class="string">'env'</span>, <span class="string">'production'</span>);</span><br><span class="line"><span class="comment">// 设定静态档案位置</span></span><br><span class="line">app.use(<span class="string">'/static'</span>, Express.static(__dirname + <span class="string">'/public'</span>));</span><br><span class="line">app.use(cookieParser());</span><br><span class="line"><span class="comment">// use body parser so we can get info from POST and/or URL parameters</span></span><br><span class="line">app.use(bodyParser.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;)); <span class="comment">// only can deal with key/value</span></span><br><span class="line">app.use(bodyParser.json());</span><br><span class="line"><span class="comment">// use morgan to log requests to the console</span></span><br><span class="line">app.use(morgan(<span class="string">'dev'</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 负责每次接受到 request 的处理函数，判断该如何处理和取得 initialState 整理后结合伺服器渲染页面传往前端</span></span><br><span class="line"><span class="keyword">const</span> handleRender = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// Query our mock API asynchronously</span></span><br><span class="line">  match(&#123; routes, <span class="attr">location</span>: req.url &#125;, (error, redirectLocation, renderProps) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">      res.status(<span class="number">500</span>).send(error.message);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (redirectLocation) &#123;</span><br><span class="line">      res.redirect(<span class="number">302</span>, redirectLocation.pathname + redirectLocation.search);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (renderProps == <span class="literal">null</span>) &#123;</span><br><span class="line">      res.status(<span class="number">404</span>).send(<span class="string">'Not found'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fetchComponentData(req.cookies.token).then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> isAuthorized = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (response[<span class="number">1</span>].data.success === <span class="literal">true</span>) &#123;</span><br><span class="line">         isAuthorized = <span class="literal">true</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        isAuthorized = <span class="literal">false</span>;        </span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> initialState = fromJS(&#123;</span><br><span class="line">        recipe: &#123;</span><br><span class="line">          recipes: response[<span class="number">0</span>].data,</span><br><span class="line">          recipe: &#123;</span><br><span class="line">            id: <span class="string">''</span>,</span><br><span class="line">            name: <span class="string">''</span>, </span><br><span class="line">            description: <span class="string">''</span>, </span><br><span class="line">            imagePath: <span class="string">''</span>,            </span><br><span class="line">          &#125;  </span><br><span class="line">        &#125;,</span><br><span class="line">        user: &#123;</span><br><span class="line">          isAuthorized: isAuthorized,</span><br><span class="line">          isEdit: <span class="literal">false</span>,</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="comment">// server side 渲染页面</span></span><br><span class="line">      <span class="comment">// Create a new Redux store instance</span></span><br><span class="line">      <span class="keyword">const</span> store = configureStore(initialState);</span><br><span class="line">      <span class="keyword">const</span> initView = renderToString(</span><br><span class="line">        &lt;Provider store=&#123;store&#125;&gt;</span><br><span class="line">          &lt;RouterContext &#123;...renderProps&#125; /&gt;</span><br><span class="line">        &lt;<span class="regexp">/Provider&gt;</span></span><br><span class="line"><span class="regexp">      );</span></span><br><span class="line"><span class="regexp">      let state = store.getState();</span></span><br><span class="line"><span class="regexp">      let page = renderFullPage(initView, state);</span></span><br><span class="line"><span class="regexp">      return res.status(200).send(page);</span></span><br><span class="line"><span class="regexp">    &#125;)</span></span><br><span class="line"><span class="regexp">    .catch(err =&gt; res.end(err.message));</span></span><br><span class="line"><span class="regexp">  &#125;)</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 基础页面 HTML 设计</span></span><br><span class="line"><span class="regexp">const renderFullPage = (html, preloadedState) =&gt; (`</span></span><br><span class="line"><span class="regexp">    &lt;!doctype html&gt;</span></span><br><span class="line"><span class="regexp">    &lt;html&gt;</span></span><br><span class="line"><span class="regexp">      &lt;head&gt;</span></span><br><span class="line"><span class="regexp">        &lt;title&gt;OpenCook 分享料理的美好时光&lt;/</span>title&gt;</span><br><span class="line">        &lt;!-- Latest compiled and minified CSS --&gt;</span><br><span class="line">        &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"//maxcdn.bootstrapcdn.com/bootstrap/latest/css/bootstrap.min.css"</span>&gt;</span><br><span class="line">        &lt;!-- Optional theme --&gt;</span><br><span class="line">        &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"//maxcdn.bootstrapcdn.com/bootstrap/latest/css/bootstrap-theme.min.css"</span>&gt;</span><br><span class="line">        &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"//maxcdn.bootstrapcdn.com/bootswatch/3.3.7/journal/bootstrap.min.css"</span>&gt;</span><br><span class="line">      &lt;body&gt;</span><br><span class="line">        &lt;div id=<span class="string">"app"</span>&gt;$&#123;html&#125;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        &lt;script&gt;</span></span><br><span class="line"><span class="regexp">          window.__PRELOADED_STATE__ = $&#123;JSON.stringify(preloadedState).replace(/</span>&lt;<span class="regexp">/g, '\\x3c')&#125;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>script&gt;</span><br><span class="line">        &lt;script src=<span class="string">"/static/bundle.js"</span>&gt;&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>body&gt;</span><br><span class="line">    &lt;<span class="regexp">/html&gt;`</span></span><br><span class="line"><span class="regexp">);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 设定 hot reload middleware</span></span><br><span class="line"><span class="regexp">const compiler = webpack(webpackConfig);</span></span><br><span class="line"><span class="regexp">app.use(webpackDevMiddleware(compiler, &#123; noInfo: true, publicPath: webpackConfig.output.publicPath &#125;));</span></span><br><span class="line"><span class="regexp">app.use(webpackHotMiddleware(compiler));</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 设计 API prefix，并使用 controller 中的 apiRoutes 进行处理</span></span><br><span class="line"><span class="regexp">app.use('/</span>api<span class="string">', apiRoutes);  </span></span><br><span class="line"><span class="string">// 使用伺服器端 handleRender </span></span><br><span class="line"><span class="string">app.use(handleRender);</span></span><br><span class="line"><span class="string">app.listen(port, (error) =&gt; &#123;</span></span><br><span class="line"><span class="string">  if (error) &#123;</span></span><br><span class="line"><span class="string">    console.error(error)</span></span><br><span class="line"><span class="string">  &#125; else &#123;</span></span><br><span class="line"><span class="string">    console.info(`==&gt; 🌎  Listening on port $&#123;port&#125;. Open up http://localhost:$&#123;port&#125;/ in your browser.`)</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;);</span></span><br></pre></td></tr></table></figure>
<p>由于 Node 端要到新版对于 ES6 支援较好，所以先用 <code>babel-register</code> 在 <code>src/server/index.js</code> 去即时转译 <code>server.js</code>，但目前不建议在 <code>production</code> 环境使用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// use babel-register to precompile ES6 syntax</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'babel-register'</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">'./server'</span>);</span><br></pre></td></tr></table></figure>
<p>现在我们来设计一下我们资料库的 Schema，在这边我们使用 MongoDB 的 ORM Mongoose，可以方便我们使用物件方式进行资料库的操作：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入 mongoose 和 Schema</span></span><br><span class="line"><span class="keyword">import</span> mongoose, &#123; Schema &#125; <span class="keyword">from</span> <span class="string">'mongoose'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 mongoose.model 建立新的资料表，并将 Schema 传入</span></span><br><span class="line"><span class="comment">// 这边我们设计了食谱分享的一些基本要素，包括名称、描述、照片位置等</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> mongoose.model(<span class="string">'Recipe'</span>, <span class="keyword">new</span> Schema(&#123; </span><br><span class="line">    id: <span class="built_in">String</span>,</span><br><span class="line">    name: <span class="built_in">String</span>, </span><br><span class="line">    description: <span class="built_in">String</span>, </span><br><span class="line">    imagePath: <span class="built_in">String</span>,</span><br><span class="line">    steps: <span class="built_in">Array</span>,</span><br><span class="line">    updatedAt: <span class="built_in">Date</span>,</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入 mongoose 和 Schema</span></span><br><span class="line"><span class="keyword">import</span> mongoose, &#123; Schema &#125; <span class="keyword">from</span> <span class="string">'mongoose'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 mongoose.model 建立新的资料表，并将 Schema 传入</span></span><br><span class="line"><span class="comment">// 这边我们设计了使用者的一些基本要素，包括名称、描述、照片位置等</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> mongoose.model(<span class="string">'User'</span>, <span class="keyword">new</span> Schema(&#123; </span><br><span class="line">    id: <span class="built_in">Number</span>,</span><br><span class="line">    username: <span class="built_in">String</span>, </span><br><span class="line">    email: <span class="built_in">String</span>,</span><br><span class="line">    password: <span class="built_in">String</span>, </span><br><span class="line">    admin: <span class="built_in">Boolean</span> </span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>
<p>为了方便维护，我们把 API 的部份统一在 <code>src/server/controllers/api.js</code> 进行管理，这部份会涉及比较多 Node 和 mongoose 的操作，若读者尚不熟悉可以参考 <a href="http://mongoosejs.com/" target="_blank" rel="noopener">mongoose 官网</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Express <span class="keyword">from</span> <span class="string">'express'</span>;</span><br><span class="line"><span class="comment">// 引入 jsonwebtoken 套件 </span></span><br><span class="line"><span class="keyword">import</span> jwt <span class="keyword">from</span> <span class="string">'jsonwebtoken'</span>;</span><br><span class="line"><span class="comment">// 引入 User、Recipe Model 方便进行资料库操作</span></span><br><span class="line"><span class="keyword">import</span> User <span class="keyword">from</span> <span class="string">'../models/user'</span>;</span><br><span class="line"><span class="keyword">import</span> Recipe <span class="keyword">from</span> <span class="string">'../models/recipe'</span>;</span><br><span class="line"><span class="keyword">import</span> config <span class="keyword">from</span> <span class="string">'../config'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// API Route</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Express();</span><br><span class="line"><span class="keyword">const</span> apiRoutes = Express.Router();</span><br><span class="line"><span class="comment">// 设定 JSON Web Token 的 secret variable</span></span><br><span class="line">app.set(<span class="string">'superSecret'</span>, config.secret); <span class="comment">// secret variable</span></span><br><span class="line"><span class="comment">// 使用者登入 API ，依据使用 email 和 密码去验证，若成功则回传一个认证 token（时效24小时）我们把它存在 cookie 中，方便前后端存取。这边我们先不考虑太多资讯安全的议题</span></span><br><span class="line">apiRoutes.post(<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// find the user</span></span><br><span class="line">  User.findOne(&#123;</span><br><span class="line">    email: req.body.email</span><br><span class="line">  &#125;, (err, user) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      res.json(&#123; <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">message</span>: <span class="string">'Authentication failed. User not found.'</span> &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (user) &#123;</span><br><span class="line">      <span class="comment">// check if password matches</span></span><br><span class="line">      <span class="keyword">if</span> (user.password != req.body.password) &#123;</span><br><span class="line">        res.json(&#123; <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">message</span>: <span class="string">'Authentication failed. Wrong password.'</span> &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// if user is found and password is right</span></span><br><span class="line">        <span class="comment">// create a token</span></span><br><span class="line">        <span class="keyword">const</span> token = jwt.sign(&#123; <span class="attr">email</span>: user.email &#125;, app.get(<span class="string">'superSecret'</span>), &#123;</span><br><span class="line">          expiresIn: <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> <span class="comment">// expires in 24 hours</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// return the information including token as JSON</span></span><br><span class="line">        <span class="comment">// 若登入成功回传一个 json 讯息</span></span><br><span class="line">        res.json(&#123;</span><br><span class="line">          success: <span class="literal">true</span>,</span><br><span class="line">          message: <span class="string">'Enjoy your token!'</span>,</span><br><span class="line">          token: token,</span><br><span class="line">          userId: user._id</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;   </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 初始化 api，一开始资料库尚未建立任何使用者，我们需要在浏览器输入 `http://localhost:3000/api/setup`，进行资料库初始化。这个动作将新增一个使用者、一份食谱，若是成功新增将回传一个 success 讯息</span></span><br><span class="line">apiRoutes.get(<span class="string">'/setup'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="comment">// create a sample user</span></span><br><span class="line">  <span class="keyword">const</span> sampleUser = <span class="keyword">new</span> User(&#123; </span><br><span class="line">    username: <span class="string">'mark'</span>, </span><br><span class="line">    email: <span class="string">'mark@demo.com'</span>, </span><br><span class="line">    password: <span class="string">'123456'</span>,</span><br><span class="line">    admin: <span class="literal">true</span> </span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">const</span> sampleRecipe = <span class="keyword">new</span> Recipe(&#123;</span><br><span class="line">    id: <span class="string">'110ec58a-a0f2-4ac4-8393-c866d813b8d1'</span>,</span><br><span class="line">    name: <span class="string">'番茄炒蛋'</span>, </span><br><span class="line">    description: <span class="string">'番茄炒蛋，一道非常经典的家常菜料理。虽然看似普通，但每个家庭都有属于自己家裡的不同味道'</span>, </span><br><span class="line">    imagePath: <span class="string">'https://c1.staticflickr.com/6/5011/5510599760_6668df5a8a_z.jpg'</span>,</span><br><span class="line">    steps: [<span class="string">'放入番茄'</span>, <span class="string">'打个蛋'</span>, <span class="string">'放入少许盐巴'</span>, <span class="string">'用心快炒'</span>],</span><br><span class="line">    updatedAt: <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// save the sample user</span></span><br><span class="line">  sampleUser.save(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">    sampleRecipe.save(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'User saved successfully'</span>);</span><br><span class="line">      res.json(&#123; <span class="attr">success</span>: <span class="literal">true</span> &#125;);      </span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 回传所有 recipes</span></span><br><span class="line">apiRoutes.get(<span class="string">'/recipes'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  Recipe.find(&#123;&#125;, (err, recipes) =&gt; &#123;</span><br><span class="line">    res.status(<span class="number">200</span>).json(recipes);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// route middleware to verify a token</span></span><br><span class="line"><span class="comment">// 接下来的 api 将进行控管，也就是说必须在网址请求中夹带认证 token 才能完成请求</span></span><br><span class="line">apiRoutes.use(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// check header or url parameters or post parameters for token</span></span><br><span class="line">  <span class="comment">// 确认标头、网址或 post 参数是否含有 token，本范例因为简便使用网址 query 参数 </span></span><br><span class="line">  <span class="keyword">var</span> token = req.body.token || req.query.token || req.headers[<span class="string">'x-access-token'</span>];</span><br><span class="line">  <span class="comment">// decode token</span></span><br><span class="line">  <span class="keyword">if</span> (token) &#123;</span><br><span class="line">    <span class="comment">// verifies secret and checks exp</span></span><br><span class="line">    jwt.verify(token, app.get(<span class="string">'superSecret'</span>), (err, decoded) =&gt; &#123;      </span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.json(&#123; <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">message</span>: <span class="string">'Failed to authenticate token.'</span> &#125;);    </span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// if everything is good, save to request for use in other routes</span></span><br><span class="line">        req.decoded = decoded;    </span><br><span class="line">        next();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// if there is no token</span></span><br><span class="line">    <span class="comment">// return an error</span></span><br><span class="line">    <span class="keyword">return</span> res.status(<span class="number">403</span>).send(&#123; </span><br><span class="line">        success: <span class="literal">false</span>, </span><br><span class="line">        message: <span class="string">'No token provided.'</span> </span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 确认认证是否成功</span></span><br><span class="line">apiRoutes.get(<span class="string">'/authenticate'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.json(&#123;</span><br><span class="line">    success: <span class="literal">true</span>,</span><br><span class="line">    message: <span class="string">'Enjoy your token!'</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// create recipe 新增食谱</span></span><br><span class="line">apiRoutes.post(<span class="string">'/recipes'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> newRecipe = <span class="keyword">new</span> Recipe(&#123;</span><br><span class="line">    name: req.body.name, </span><br><span class="line">    description: req.body.description, </span><br><span class="line">    imagePath: req.body.imagePath,</span><br><span class="line">    steps: [<span class="string">'放入番茄'</span>, <span class="string">'打个蛋'</span>, <span class="string">'放入少许盐巴'</span>, <span class="string">'用心快炒'</span>],</span><br><span class="line">    updatedAt: <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">  &#125;);</span><br><span class="line">  newRecipe.save(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'User saved successfully'</span>);</span><br><span class="line">    res.json(&#123; <span class="attr">success</span>: <span class="literal">true</span> &#125;);      </span><br><span class="line">  &#125;);</span><br><span class="line">&#125;); </span><br><span class="line"><span class="comment">// update recipe 根据 _id（mongodb 的 id）更新食谱</span></span><br><span class="line">apiRoutes.put(<span class="string">'/recipes/:id'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  Recipe.update(&#123; <span class="attr">_id</span>: req.params.id &#125;, &#123;</span><br><span class="line">    name: req.body.name, </span><br><span class="line">    description: req.body.description, </span><br><span class="line">    imagePath: req.body.imagePath,</span><br><span class="line">    steps: [<span class="string">'放入番茄'</span>, <span class="string">'打个蛋'</span>, <span class="string">'放入少许盐巴'</span>, <span class="string">'用心快炒'</span>],</span><br><span class="line">    updatedAt: <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">  &#125; ,(err) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'User updated successfully'</span>);</span><br><span class="line">    res.json(&#123; <span class="attr">success</span>: <span class="literal">true</span> &#125;);      </span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// remove recipe 根据 _id 删除食谱，若成功回传成功讯息</span></span><br><span class="line">apiRoutes.delete(<span class="string">'/recipes/:id'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  Recipe.remove(&#123; <span class="attr">_id</span>: req.params.id &#125;, (err, recipe) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'remove saved successfully'</span>);</span><br><span class="line">    res.json(&#123; <span class="attr">success</span>: <span class="literal">true</span> &#125;); </span><br><span class="line">  &#125;);</span><br><span class="line">&#125;); </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> apiRoutes;</span><br></pre></td></tr></table></figure>
<p>设定整个 App 的 routing，我们主要页面有 <code>HomePageContainer</code>、<code>LoginPageContainer</code>、<code>SharePageContainer</code>，值得注意的是我们这边使用 <a href="http://www.darul.io/post/2016-01-05_react-higher-order-components" target="_blank" rel="noopener">Higher Order Components</a> （Higher Order Components 为一个函数， 接收一个 Component 后在 Class Component 的 render 中 return 回传入的 components）方式去确认使用者是否有登入，若有没登入则不能进入分享食谱页面，反之若已登入也不会再进到登入页面：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Route, IndexRoute &#125; <span class="keyword">from</span> <span class="string">'react-router'</span>;</span><br><span class="line"><span class="keyword">import</span> Main <span class="keyword">from</span> <span class="string">'../components/Main'</span>;</span><br><span class="line"><span class="keyword">import</span> CheckAuth <span class="keyword">from</span> <span class="string">'../components/CheckAuth'</span>;</span><br><span class="line"><span class="keyword">import</span> HomePageContainer <span class="keyword">from</span> <span class="string">'../containers/HomePageContainer'</span>;</span><br><span class="line"><span class="keyword">import</span> LoginPageContainer <span class="keyword">from</span> <span class="string">'../containers/LoginPageContainer'</span>;</span><br><span class="line"><span class="keyword">import</span> SharePageContainer <span class="keyword">from</span> <span class="string">'../containers/SharePageContainer'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (</span><br><span class="line">  &lt;Route path=<span class="string">'/'</span> component=&#123;Main&#125;&gt;</span><br><span class="line">    &lt;IndexRoute component=&#123;HomePageContainer&#125; /&gt;</span><br><span class="line">    &lt;Route path=<span class="string">"/login"</span> component=&#123;CheckAuth(LoginPageContainer, <span class="string">'guest'</span>)&#125;/&gt;</span><br><span class="line">    &lt;Route path=<span class="string">"/share"</span> component=&#123;CheckAuth(SharePageContainer, <span class="string">'auth'</span>)&#125;/&gt;</span><br><span class="line">  &lt;<span class="regexp">/Route&gt;</span></span><br><span class="line"><span class="regexp">);</span></span><br></pre></td></tr></table></figure>
<p>设定行为常数（<code>src/constants/actionTypes.js</code>）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> AUTH_START    = <span class="string">"AUTH_START"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> AUTH_COMPLETE = <span class="string">"AUTH_COMPLETE"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> AUTH_ERROR    = <span class="string">"AUTH_ERROR"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> START_LOGOUT    = <span class="string">"START_LOGOUT"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> CHECK_AUTH    = <span class="string">"CHECK_AUTH"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> SET_USER    = <span class="string">"SET_USER"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> SHOW_SPINNER    = <span class="string">"SHOW_SPINNER"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> HIDE_SPINNER    = <span class="string">"HIDE_SPINNER"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> SET_UI    = <span class="string">"SET_UI"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> GET_RECIPES = <span class="string">'GET_RECIPES'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> SET_RECIPE = <span class="string">'SET_RECIPE'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ADD_RECIPE = <span class="string">'ADD_RECIPE'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> UPDATE_RECIPE = <span class="string">'UPDATE_RECIPE'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> DELETE_RECIPE = <span class="string">'DELETE_RECIPE'</span>;</span><br></pre></td></tr></table></figure>
<p>设定 <code>src/actions/recipeActions.js</code>，我们这边使用 redux-promise，可以很容易使用非同步的行为 WebAPI：  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createAction &#125; <span class="keyword">from</span> <span class="string">'redux-actions'</span>;</span><br><span class="line"><span class="keyword">import</span> WebAPI <span class="keyword">from</span> <span class="string">'../utils/WebAPI'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  GET_RECIPES,</span><br><span class="line">  ADD_RECIPE,</span><br><span class="line">  UPDATE_RECIPE,</span><br><span class="line">  DELETE_RECIPE,</span><br><span class="line">  SET_RECIPE,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'../constants/actionTypes'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getRecipes = createAction(<span class="string">'GET_RECIPES'</span>, WebAPI.getRecipes);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> addRecipe = createAction(<span class="string">'ADD_RECIPE'</span>, WebAPI.addRecipe);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> updateRecipe = createAction(<span class="string">'UPDATE_RECIPE'</span>, WebAPI.updateRecipe);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> deleteRecipe = createAction(<span class="string">'DELETE_RECIPE'</span>, WebAPI.deleteRecipe);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> setRecipe = createAction(<span class="string">'SET_RECIPE'</span>);</span><br></pre></td></tr></table></figure>
<p>设定 <code>src/actions/uiActions.js</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createAction &#125; <span class="keyword">from</span> <span class="string">'redux-actions'</span>;</span><br><span class="line"><span class="keyword">import</span> WebAPI <span class="keyword">from</span> <span class="string">'../utils/WebAPI'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  SHOW_SPINNER,</span><br><span class="line">  HIDE_SPINNER,</span><br><span class="line">  SET_UI,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'../constants/actionTypes'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> showSpinner = createAction(<span class="string">'SHOW_SPINNER'</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> hideSpinner = createAction(<span class="string">'HIDE_SPINNER'</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> setUi = createAction(<span class="string">'SET_UI'</span>);</span><br></pre></td></tr></table></figure>
<p>设定 <code>src/actions/userActions.js</code>，处理使用者登入登出等行为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createAction &#125; <span class="keyword">from</span> <span class="string">'redux-actions'</span>;</span><br><span class="line"><span class="keyword">import</span> WebAPI <span class="keyword">from</span> <span class="string">'../utils/WebAPI'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  AUTH_START,</span><br><span class="line">  AUTH_COMPLETE,</span><br><span class="line">  AUTH_ERROR,</span><br><span class="line">  START_LOGOUT,</span><br><span class="line">  CHECK_AUTH,</span><br><span class="line">  SET_USER</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'../constants/actionTypes'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> authStart = createAction(<span class="string">'AUTH_START'</span>, WebAPI.login);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> authComplete = createAction(<span class="string">'AUTH_COMPLETE'</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> authError = createAction(<span class="string">'AUTH_ERROR'</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> startLogout = createAction(<span class="string">'START_LOGOUT'</span>, WebAPI.logout);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> checkAuth = createAction(<span class="string">'CHECK_AUTH'</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> setUser = createAction(<span class="string">'SET_USER'</span>);</span><br></pre></td></tr></table></figure>
<p>于 <code>scr/actions/index.js</code> 输出 actions：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> * <span class="keyword">from</span> <span class="string">'./userActions'</span>;</span><br><span class="line"><span class="keyword">export</span> * <span class="keyword">from</span> <span class="string">'./recipeActions'</span>;</span><br><span class="line"><span class="keyword">export</span> * <span class="keyword">from</span> <span class="string">'./uiActions'</span>;</span><br></pre></td></tr></table></figure>
<p>于 <code>scr/common/utils/fetchComponentData.js</code> 设定 server side 初始 fetchComponentData：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这边使用 axios 方便进行 promises base request</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">'axios'</span>;</span><br><span class="line"><span class="comment">// 记得附加上我们存在 cookies 的 token  </span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">fetchComponentData</span>(<span class="params">token = <span class="string">'token'</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> promises = [axios.get(<span class="string">'http://localhost:3000/api/recipes'</span>), axios.get(<span class="string">'http://localhost:3000/api/authenticate?token='</span> + token)];</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.all(promises);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>于 <code>scr/common/utils/WebAPI.js</code> 所有前端 API 的处理：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">'axios'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; browserHistory &#125; <span class="keyword">from</span> <span class="string">'react-router'</span>;</span><br><span class="line"><span class="comment">// 引入 uuid 当做食谱 id</span></span><br><span class="line"><span class="keyword">import</span> uuid <span class="keyword">from</span> <span class="string">'uuid'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; </span><br><span class="line">  authComplete,</span><br><span class="line">  authError,</span><br><span class="line">  hideSpinner,</span><br><span class="line">  completeLogout,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'../actions'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// getCookie 函数传入 key 回传 value</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCookie</span>(<span class="params">keyName</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> name = keyName + <span class="string">'='</span>;</span><br><span class="line">  <span class="keyword">const</span> cookies = <span class="built_in">document</span>.cookie.split(<span class="string">';'</span>);</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; cookies.length; i++) &#123;</span><br><span class="line">      <span class="keyword">let</span> cookie = cookies[i];</span><br><span class="line">      <span class="keyword">while</span> (cookie.charAt(<span class="number">0</span>)==<span class="string">' '</span>) &#123;</span><br><span class="line">          cookie = cookie.substring(<span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (cookie.indexOf(name) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> cookie.substring(name.length, cookie.length);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// 呼叫后端登入 api</span></span><br><span class="line">  login: <span class="function">(<span class="params">dispatch, email, password</span>) =&gt;</span> &#123;</span><br><span class="line">    axios.post(<span class="string">'/api/login'</span>, &#123;</span><br><span class="line">      email: email,</span><br><span class="line">      password: password</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span>(response.data.success === <span class="literal">false</span>) &#123;</span><br><span class="line">        dispatch(authError()); </span><br><span class="line">        dispatch(hideSpinner());  </span><br><span class="line">        alert(<span class="string">'发生错误，请再试一次！'</span>);</span><br><span class="line">        <span class="built_in">window</span>.location.reload();        </span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">document</span>.cookie.token) &#123;</span><br><span class="line">          <span class="keyword">let</span> d = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">          d.setTime(d.getTime() + (<span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>));</span><br><span class="line">          <span class="keyword">const</span> expires = <span class="string">'expires='</span> + d.toUTCString();</span><br><span class="line">          <span class="built_in">document</span>.cookie = <span class="string">'token='</span> + response.data.token + <span class="string">'; '</span> + expires;</span><br><span class="line">          dispatch(authComplete());</span><br><span class="line">          dispatch(hideSpinner());  </span><br><span class="line">          browserHistory.push(<span class="string">'/'</span>); </span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">      dispatch(authError());</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 呼叫后端登出 api  </span></span><br><span class="line">  logout: <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">document</span>.cookie = <span class="string">'token=; '</span> + <span class="string">'expires=Thu, 01 Jan 1970 00:00:01 GMT;'</span>;</span><br><span class="line">    dispatch(hideSpinner());  </span><br><span class="line">    browserHistory.push(<span class="string">'/'</span>); </span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 确认使用者是否登入    </span></span><br><span class="line">  checkAuth: <span class="function">(<span class="params">dispatch, token</span>) =&gt;</span> &#123;</span><br><span class="line">    axios.post(<span class="string">'/api/authenticate'</span>, &#123;</span><br><span class="line">      token: token,</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span>(response.data.success === <span class="literal">false</span>) &#123;</span><br><span class="line">        dispatch(authError()); </span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dispatch(authComplete());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">      dispatch(authError());</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 取得目前所有食谱    </span></span><br><span class="line">  getRecipes: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    axios.get(<span class="string">'/api/recipes'</span>)</span><br><span class="line">    .then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 呼叫新增食谱 api，记得附加上我们存在 cookies 的 token  </span></span><br><span class="line">  addRecipe: <span class="function">(<span class="params">dispatch, name, description, imagePath</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> id = uuid.v4();</span><br><span class="line">    axios.post(<span class="string">'/api/recipes?token='</span> + getCookie(<span class="string">'token'</span>), &#123;</span><br><span class="line">      id: id,</span><br><span class="line">      name: name,</span><br><span class="line">      description: description,</span><br><span class="line">      imagePath: imagePath,</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span>(response.data.success === <span class="literal">false</span>) &#123;</span><br><span class="line">        dispatch(hideSpinner());  </span><br><span class="line">        alert(<span class="string">'发生错误，请再试一次！'</span>);</span><br><span class="line">        browserHistory.push(<span class="string">'/share'</span>);         </span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dispatch(hideSpinner());  </span><br><span class="line">        <span class="built_in">window</span>.location.reload();        </span><br><span class="line">        browserHistory.push(<span class="string">'/'</span>); </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 呼叫更新食谱 api，记得附加上我们存在 cookies 的 token  </span></span><br><span class="line">  updateRecipe: <span class="function">(<span class="params">dispatch, recipeId, name, description, imagePath</span>) =&gt;</span> &#123;</span><br><span class="line">    axios.put(<span class="string">'/api/recipes/'</span> + recipeId + <span class="string">'?token='</span> + getCookie(<span class="string">'token'</span>), &#123;</span><br><span class="line">      id: recipeId,</span><br><span class="line">      name: name,</span><br><span class="line">      description: description,</span><br><span class="line">      imagePath: imagePath,</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span>(response.data.success === <span class="literal">false</span>) &#123;</span><br><span class="line">        dispatch(hideSpinner());  </span><br><span class="line">        dispatch(setRecipe(&#123; <span class="attr">key</span>: <span class="string">'recipeId'</span>, <span class="attr">value</span>: <span class="string">''</span> &#125;));</span><br><span class="line">        dispatch(setUi(&#123; <span class="attr">key</span>: <span class="string">'isEdit'</span>, <span class="attr">value</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">        alert(<span class="string">'发生错误，请再试一次！'</span>);</span><br><span class="line">        browserHistory.push(<span class="string">'/share'</span>);         </span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dispatch(hideSpinner());  </span><br><span class="line">        <span class="built_in">window</span>.location.reload();        </span><br><span class="line">        browserHistory.push(<span class="string">'/'</span>); </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 呼叫删除食谱 api，记得附加上我们存在 cookies 的 token  </span></span><br><span class="line">  deleteRecipe: <span class="function">(<span class="params">dispatch, recipeId</span>) =&gt;</span> &#123;</span><br><span class="line">    axios.delete(<span class="string">'/api/recipes/'</span> + recipeId + <span class="string">'?token='</span> + getCookie(<span class="string">'token'</span>))</span><br><span class="line">    .then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span>(response.data.success === <span class="literal">false</span>) &#123;</span><br><span class="line">        dispatch(hideSpinner());  </span><br><span class="line">        alert(<span class="string">'发生错误，请再试一次！'</span>);</span><br><span class="line">        browserHistory.push(<span class="string">'/'</span>);         </span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dispatch(hideSpinner());  </span><br><span class="line">        <span class="built_in">window</span>.location.reload();        </span><br><span class="line">        browserHistory.push(<span class="string">'/'</span>); </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">    &#125;);    </span><br><span class="line">  &#125; </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>接下来设定我们的 <code>reducers</code>，以下是 <code>src/common/reducers/data/recipeReducers.js</code>，<code>GET_RECIPES</code> 负责将后端 API 取得的所有食谱存放在 recipes 中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; handleActions &#125; <span class="keyword">from</span> <span class="string">'redux-actions'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; RecipeState &#125; <span class="keyword">from</span> <span class="string">'../../constants/models'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  GET_RECIPES,</span><br><span class="line">  SET_RECIPE,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'../../constants/actionTypes'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> recipeReducers = handleActions(&#123;</span><br><span class="line">  GET_RECIPES: <span class="function">(<span class="params">state, &#123; payload &#125;</span>) =&gt;</span> (</span><br><span class="line">    state.set(</span><br><span class="line">      <span class="string">'recipes'</span>,</span><br><span class="line">      payload.recipes</span><br><span class="line">    )</span><br><span class="line">  ),</span><br><span class="line">  SET_RECIPE: <span class="function">(<span class="params">state, &#123; payload &#125;</span>) =&gt;</span> (</span><br><span class="line">    state.setIn(payload.keyPath, payload.value)</span><br><span class="line">  ),  </span><br><span class="line">&#125;, RecipeState);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> recipeReducers;</span><br></pre></td></tr></table></figure>
<p>以下是 <code>src/common/reducers/data/userReducers.js</code>，负责确认登入相关处理事项。注意的是由于登入是非同步执行，所以会有几个阶段的行为要做处理：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; handleActions &#125; <span class="keyword">from</span> <span class="string">'redux-actions'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserState &#125; <span class="keyword">from</span> <span class="string">'../../constants/models'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  AUTH_START,</span><br><span class="line">  AUTH_COMPLETE,</span><br><span class="line">  AUTH_ERROR,</span><br><span class="line">  LOGOUT_START,</span><br><span class="line">  SET_USER,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'../../constants/actionTypes'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> userReducers = handleActions(&#123;</span><br><span class="line">  AUTH_START: <span class="function">(<span class="params">state</span>) =&gt;</span> (</span><br><span class="line">    state.merge(&#123;</span><br><span class="line">      isAuthorized: <span class="literal">false</span>,      </span><br><span class="line">    &#125;)</span><br><span class="line">  ),  </span><br><span class="line">  AUTH_COMPLETE: <span class="function">(<span class="params">state</span>) =&gt;</span> (</span><br><span class="line">    state.merge(&#123;</span><br><span class="line">      email: <span class="string">''</span>,</span><br><span class="line">      password: <span class="string">''</span>,</span><br><span class="line">      isAuthorized: <span class="literal">true</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  ),  </span><br><span class="line">  AUTH_ERROR: <span class="function">(<span class="params">state</span>) =&gt;</span> (</span><br><span class="line">    state.merge(&#123;</span><br><span class="line">      username: <span class="string">''</span>,</span><br><span class="line">      email: <span class="string">''</span>,</span><br><span class="line">      password: <span class="string">''</span>,</span><br><span class="line">      isAuthorized: <span class="literal">false</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  ),  </span><br><span class="line">  START_LOGOUT: <span class="function">(<span class="params">state</span>) =&gt;</span> (</span><br><span class="line">    state.merge(&#123;</span><br><span class="line">      isAuthorized: <span class="literal">false</span>,      </span><br><span class="line">    &#125;)</span><br><span class="line">  ), </span><br><span class="line">  CHECK_AUTH: <span class="function">(<span class="params">state</span>) =&gt;</span> (</span><br><span class="line">    state.set(<span class="string">'isAuthorized'</span>, <span class="literal">true</span>)</span><br><span class="line">  ),</span><br><span class="line">  SET_USER: <span class="function">(<span class="params">state, &#123; payload &#125;</span>) =&gt;</span> (</span><br><span class="line">    state.set(payload.key, payload.value)</span><br><span class="line">  ),</span><br><span class="line">&#125;, UserState);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> userReducers;</span><br></pre></td></tr></table></figure>
<p>以下是 <code>src/common/reducers/ui/uiReducers.js</code>，负责确认 UI State 相关处理：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; handleActions &#125; <span class="keyword">from</span> <span class="string">'redux-actions'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UiState &#125; <span class="keyword">from</span> <span class="string">'../../constants/models'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  SHOW_SPINNER,</span><br><span class="line">  HIDE_SPINNER,</span><br><span class="line">  SET_UI,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'../../constants/actionTypes'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> uiReducers = handleActions(&#123;</span><br><span class="line">  SHOW_SPINNER: <span class="function">(<span class="params">state</span>) =&gt;</span> (</span><br><span class="line">    state.set(</span><br><span class="line">      <span class="string">'spinnerVisible'</span>,</span><br><span class="line">      <span class="literal">true</span></span><br><span class="line">    )</span><br><span class="line">  ),</span><br><span class="line">  HIDE_SPINNER: <span class="function">(<span class="params">state</span>) =&gt;</span> (</span><br><span class="line">    state.set(</span><br><span class="line">      <span class="string">'spinnerVisible'</span>,</span><br><span class="line">      <span class="literal">false</span></span><br><span class="line">    )</span><br><span class="line">  ),</span><br><span class="line">  SET_UI: <span class="function">(<span class="params">state, &#123; payload &#125;</span>) =&gt;</span> (</span><br><span class="line">    state.set(payload.key, payload.value)</span><br><span class="line">  ),    </span><br><span class="line">&#125;, UiState);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> uiReducers;</span><br></pre></td></tr></table></figure>
<p>最后把所有 recipes 在 <code>src/common/reducers/index.js</code> 使用 <code>combineReducers</code> 整合在一起，注意的是我们整个 App 的资料流要维持 immutable： </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; combineReducers &#125; <span class="keyword">from</span> <span class="string">'redux-immutable'</span>;</span><br><span class="line"><span class="keyword">import</span> ui <span class="keyword">from</span> <span class="string">'./ui/uiReducers'</span>;</span><br><span class="line"><span class="keyword">import</span> recipe <span class="keyword">from</span> <span class="string">'./data/recipeReducers'</span>;</span><br><span class="line"><span class="keyword">import</span> user <span class="keyword">from</span> <span class="string">'./data/userReducers'</span>;</span><br><span class="line"><span class="comment">// import routes from './routes';</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rootReducer = combineReducers(&#123;</span><br><span class="line">  ui,</span><br><span class="line">  recipe,</span><br><span class="line">  user,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> rootReducer;</span><br></pre></td></tr></table></figure>
<p>以下是 <code>src/common/store/configureStore.js</code> 处理 store 的建立，这次我们使用了 <code>promiseMiddleware</code> 的 middleware：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"><span class="keyword">import</span> promiseMiddleware <span class="keyword">from</span> <span class="string">'redux-promise'</span>;</span><br><span class="line"><span class="keyword">import</span> createLogger <span class="keyword">from</span> <span class="string">'redux-logger'</span>;</span><br><span class="line"><span class="keyword">import</span> Immutable <span class="keyword">from</span> <span class="string">'immutable'</span>;</span><br><span class="line"><span class="keyword">import</span> rootReducer <span class="keyword">from</span> <span class="string">'../reducers'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> initialState = Immutable.Map();</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">configureStore</span>(<span class="params">preloadedState = initialState</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> store = createStore(</span><br><span class="line">    rootReducer,</span><br><span class="line">    preloadedState,</span><br><span class="line">    applyMiddleware(createLogger(&#123; <span class="attr">stateTransformer</span>: <span class="function"><span class="params">state</span> =&gt;</span> state.toJS() &#125;, promiseMiddleware))</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> store;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过一连串努力，我们来到了 View 的佈建。在这个 App 中我们主要会由一个 AppBar 负责所有页面的导览，也就是每个页面都会有 AppBar 常驻在上面，然而上面的内容则会依 UI State 中的 isAuthorized 而有所不同。最后要留意的是我们使用了 React Bootstrapt 来建立 React Component。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; LinkContainer &#125; <span class="keyword">from</span> <span class="string">'react-router-bootstrap'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Link &#125; <span class="keyword">from</span> <span class="string">'react-router'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Navbar, Nav, NavItem, NavDropdown, MenuItem &#125; <span class="keyword">from</span> <span class="string">'react-bootstrap'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> AppBar = (&#123;</span><br><span class="line">  isAuthorized,</span><br><span class="line">  onToShare,</span><br><span class="line">  onLogout,</span><br><span class="line">&#125;) =&gt; (</span><br><span class="line">  &lt;Navbar&gt;</span><br><span class="line">    &lt;Navbar.Header&gt;</span><br><span class="line">      &lt;Navbar.Brand&gt;</span><br><span class="line">        &lt;Link to=<span class="string">"/"</span>&gt;OpenCook&lt;<span class="regexp">/Link&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>Navbar.Brand&gt;</span><br><span class="line">      &lt;Navbar.Toggle /&gt;</span><br><span class="line">    &lt;<span class="regexp">/Navbar.Header&gt;</span></span><br><span class="line"><span class="regexp">    &lt;Navbar.Collapse&gt;</span></span><br><span class="line"><span class="regexp">      &#123;</span></span><br><span class="line"><span class="regexp">        isAuthorized === false ?</span></span><br><span class="line"><span class="regexp">        (</span></span><br><span class="line"><span class="regexp">          &lt;Nav pullRight&gt;</span></span><br><span class="line"><span class="regexp">            &lt;LinkContainer to=&#123;&#123; pathname: '/</span>login<span class="string">' &#125;&#125;&gt;&lt;NavItem eventKey=&#123;2&#125; href="#"&gt;登入&lt;/NavItem&gt;&lt;/LinkContainer&gt;</span></span><br><span class="line"><span class="string">          &lt;/Nav&gt;</span></span><br><span class="line"><span class="string">        ) :</span></span><br><span class="line"><span class="string">        (</span></span><br><span class="line"><span class="string">          &lt;Nav pullRight&gt;</span></span><br><span class="line"><span class="string">            &lt;NavItem eventKey=&#123;1&#125; onClick=&#123;onToShare&#125;&gt;分享食谱&lt;/NavItem&gt;</span></span><br><span class="line"><span class="string">            &lt;NavItem eventKey=&#123;2&#125; onClick=&#123;onLogout&#125; href="#"&gt;登出&lt;/NavItem&gt;</span></span><br><span class="line"><span class="string">          &lt;/Nav&gt;</span></span><br><span class="line"><span class="string">        )        </span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &lt;/Navbar.Collapse&gt;</span></span><br><span class="line"><span class="string">  &lt;/Navbar&gt;</span></span><br><span class="line"><span class="string">);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">export default AppBar;</span></span><br></pre></td></tr></table></figure>
<p>以下是 <code>src/common/containers/AppBarContainer/AppBarContainer.js</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"><span class="keyword">import</span> AppBar <span class="keyword">from</span> <span class="string">'../../components/AppBar'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; browserHistory &#125; <span class="keyword">from</span> <span class="string">'react-router'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  startLogout,</span><br><span class="line">  setRecipe,</span><br><span class="line">  setUi,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'../../actions'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(</span><br><span class="line">  (state) =&gt; (&#123;</span><br><span class="line">    isAuthorized: state.getIn([<span class="string">'user'</span>, <span class="string">'isAuthorized'</span>]),</span><br><span class="line">  &#125;),</span><br><span class="line">  (dispatch) =&gt; (&#123;</span><br><span class="line">    onToShare: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      dispatch(setRecipe(&#123; <span class="attr">key</span>: <span class="string">'recipeId'</span>, <span class="attr">value</span>: <span class="string">''</span> &#125;));</span><br><span class="line">      dispatch(setUi(&#123; <span class="attr">key</span>: <span class="string">'isEdit'</span>, <span class="attr">value</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">      <span class="built_in">window</span>.location.reload();        </span><br><span class="line">      browserHistory.push(<span class="string">'/share'</span>); </span><br><span class="line">    &#125;,</span><br><span class="line">    onLogout: <span class="function"><span class="params">()</span> =&gt;</span> (</span><br><span class="line">      dispatch(startLogout(dispatch))</span><br><span class="line">    ),</span><br><span class="line">  &#125;)</span><br><span class="line">)(AppBar);</span><br></pre></td></tr></table></figure>
<p>以下是 <code>src/components/Main/Main.js</code>，透过 route 机制让 AppBarContainer 可以成为整个 App 母模版：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> AppBarContainer <span class="keyword">from</span> <span class="string">'../../containers/AppBarContainer'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Main = <span class="function">(<span class="params">props</span>) =&gt;</span> (</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;AppBarContainer /&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &#123;props.children&#125;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>div&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Main;</span><br></pre></td></tr></table></figure>
<p> 在 <code>checkAuth</code> 这个 Component 中，我们使用到了 Higher Order Components 的观念。Higher Order Components 为一个函数， 接收一个 Component 后在 Class Component 的 render 中 return 回传入的 components 方式去确认使用者是否有登入，若有没登入则不能进入分享食谱页面，反之若已登入也不会再进到登入页面：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; withRouter &#125; <span class="keyword">from</span> <span class="string">'react-router'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// High Order Component</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">requireAuthentication</span>(<span class="params">Component, type</span>) </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">AuthenticatedComponent</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    componentWillMount() &#123;</span><br><span class="line">      <span class="keyword">this</span>.checkAuth();</span><br><span class="line">    &#125;</span><br><span class="line">    componentWillReceiveProps(nextProps) &#123;</span><br><span class="line">      <span class="keyword">this</span>.checkAuth();</span><br><span class="line">    &#125;</span><br><span class="line">    checkAuth() &#123;</span><br><span class="line">      <span class="keyword">if</span>(type === <span class="string">'auth'</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.props.isAuthorized) &#123;</span><br><span class="line">          <span class="keyword">this</span>.props.router.push(<span class="string">'/'</span>);</span><br><span class="line">        &#125;        </span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.props.isAuthorized) &#123;</span><br><span class="line">          <span class="keyword">this</span>.props.router.push(<span class="string">'/'</span>);</span><br><span class="line">        &#125;                </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    render() &#123;</span><br><span class="line">      <span class="keyword">return</span> ( </span><br><span class="line">        &lt;div&gt; </span><br><span class="line">        &#123;</span><br><span class="line">          (type === <span class="string">'auth'</span>) ?</span><br><span class="line">          <span class="keyword">this</span>.props.isAuthorized === <span class="literal">true</span> ? &lt;Component &#123;...this.props &#125; /&gt; : <span class="literal">null</span></span><br><span class="line">          : <span class="keyword">this</span>.props.isAuthorized === <span class="literal">false</span> ? &lt;Component &#123;...this.props &#125; /&gt; : <span class="literal">null</span></span><br><span class="line">        &#125; </span><br><span class="line">        &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">      )</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">  &#125;;</span></span><br><span class="line"><span class="regexp">  const mapStateToProps = (state) =&gt; (&#123;</span></span><br><span class="line"><span class="regexp">    isAuthorized: state.getIn(['user', 'isAuthorized']),</span></span><br><span class="line"><span class="regexp">  &#125;);</span></span><br><span class="line"><span class="regexp">  return connect(mapStateToProps)(withRouter(AuthenticatedComponent));</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>我们将每个食谱呈现设计成 RecipeBox，以下是在 <code>src/common/components/HomePage/HomePage.js</code> 使用 map 方法去迭代我们的食谱：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> RecipeBoxContainer <span class="keyword">from</span> <span class="string">'../../containers/RecipeBoxContainer'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> HomePage = (&#123;</span><br><span class="line">  recipes</span><br><span class="line">&#125;) =&gt; (</span><br><span class="line">  &lt;div&gt;        </span><br><span class="line">  &#123;</span><br><span class="line">    recipes.map(<span class="function">(<span class="params">recipe, index</span>) =&gt;</span> (</span><br><span class="line">      &lt;RecipeBoxContainer recipe=&#123;recipe&#125; key=&#123;index&#125;  /&gt;</span><br><span class="line">    )).toJS()</span><br><span class="line">  &#125;</span><br><span class="line">  &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default HomePage;</span></span><br></pre></td></tr></table></figure>
<p>以下是 <code>src/common/containers/HomePageContainer/HomePageContainer.js</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"><span class="keyword">import</span> HomePage <span class="keyword">from</span> <span class="string">'../../components/HomePage'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(</span><br><span class="line">  (state) =&gt; (&#123;</span><br><span class="line">    recipes: state.getIn([<span class="string">'recipe'</span>, <span class="string">'recipes'</span>]),    </span><br><span class="line">  &#125;),</span><br><span class="line">  (dispatch) =&gt; (&#123;</span><br><span class="line">  &#125;)</span><br><span class="line">)(HomePage);</span><br></pre></td></tr></table></figure>
<p>在 <code>src/common/components/LoginBox/LoginBox.js</code> 设计我们 LoginBox：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Form, FormGroup, Button, FormControl, ControlLabel &#125; <span class="keyword">from</span> <span class="string">'react-bootstrap'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> LoginBox = (&#123;</span><br><span class="line">  email,</span><br><span class="line">  password,</span><br><span class="line">  onChangeEmailInput,</span><br><span class="line">  onChangePasswordInput,</span><br><span class="line">  onLoginSubmit</span><br><span class="line">&#125;) =&gt; (</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;Form horizontal&gt;</span><br><span class="line">      &lt;FormGroup</span><br><span class="line">        controlId=<span class="string">"formBasicText"</span></span><br><span class="line">      &gt;</span><br><span class="line">        &lt;ControlLabel&gt;请输入您的 Email&lt;<span class="regexp">/ControlLabel&gt;</span></span><br><span class="line"><span class="regexp">        &lt;FormControl</span></span><br><span class="line"><span class="regexp">          type="text"</span></span><br><span class="line"><span class="regexp">          onChange=&#123;onChangeEmailInput&#125;</span></span><br><span class="line"><span class="regexp">          placeholder="Enter Email"</span></span><br><span class="line"><span class="regexp">        /</span>&gt;</span><br><span class="line">        &lt;FormControl.Feedback /&gt;</span><br><span class="line">      &lt;<span class="regexp">/FormGroup&gt;</span></span><br><span class="line"><span class="regexp">      &lt;FormGroup</span></span><br><span class="line"><span class="regexp">        controlId="formBasicText"</span></span><br><span class="line"><span class="regexp">      &gt;</span></span><br><span class="line"><span class="regexp">        &lt;ControlLabel&gt;请输入您的密码&lt;/</span>ControlLabel&gt;</span><br><span class="line">        &lt;FormControl</span><br><span class="line">          type=<span class="string">"password"</span></span><br><span class="line">          onChange=&#123;onChangePasswordInput&#125;</span><br><span class="line">          placeholder=<span class="string">"Enter Password"</span></span><br><span class="line">        /&gt;</span><br><span class="line">        &lt;FormControl.Feedback /&gt;</span><br><span class="line">      &lt;<span class="regexp">/FormGroup&gt;</span></span><br><span class="line"><span class="regexp">      &lt;Button </span></span><br><span class="line"><span class="regexp">        onClick=&#123;onLoginSubmit&#125; </span></span><br><span class="line"><span class="regexp">        bsStyle="success" </span></span><br><span class="line"><span class="regexp">        bsSize="large" </span></span><br><span class="line"><span class="regexp">        block</span></span><br><span class="line"><span class="regexp">      &gt;</span></span><br><span class="line"><span class="regexp">        提交送出</span></span><br><span class="line"><span class="regexp">      &lt;/</span>Button&gt;</span><br><span class="line">    &lt;<span class="regexp">/Form&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>div&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> LoginBox;</span><br></pre></td></tr></table></figure>
<p>以下是 <code>src/common/containers/LoginBoxContainer/LoginBoxContainer.js</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"><span class="keyword">import</span> LoginBox <span class="keyword">from</span> <span class="string">'../../components/LoginBox'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; </span><br><span class="line">  authStart,</span><br><span class="line">  showSpinner,</span><br><span class="line">  setUser,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'../../actions'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(</span><br><span class="line">  (state) =&gt; (&#123;</span><br><span class="line">    email: state.getIn([<span class="string">'user'</span>, <span class="string">'email'</span>]),</span><br><span class="line">    password: state.getIn([<span class="string">'user'</span>, <span class="string">'password'</span>]),</span><br><span class="line">  &#125;),</span><br><span class="line">  (dispatch) =&gt; (&#123;</span><br><span class="line">    onChangeEmailInput: <span class="function">(<span class="params">event</span>) =&gt;</span> (</span><br><span class="line">      dispatch(setUser(&#123; <span class="attr">key</span>: <span class="string">'email'</span>, <span class="attr">value</span>: event.target.value &#125;))</span><br><span class="line">    ),</span><br><span class="line">    onChangePasswordInput: <span class="function">(<span class="params">event</span>) =&gt;</span> (</span><br><span class="line">      dispatch(setUser(&#123; <span class="attr">key</span>: <span class="string">'password'</span>, <span class="attr">value</span>: event.target.value &#125;))</span><br><span class="line">    ),</span><br><span class="line">    onLoginSubmit: <span class="function">(<span class="params">email, password</span>) =&gt;</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      dispatch(authStart(dispatch, email, password));</span><br><span class="line">      dispatch(showSpinner());</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;),</span><br><span class="line">  (stateProps, dispatchProps, ownProps) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; email, password &#125; = stateProps;</span><br><span class="line">    <span class="keyword">const</span> &#123; onLoginSubmit &#125; = dispatchProps;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.assign(&#123;&#125;, stateProps, dispatchProps, ownProps, &#123;</span><br><span class="line">      onLoginSubmit: onLoginSubmit(email, password),</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">)(LoginBox);</span><br></pre></td></tr></table></figure>
<p>在 <code>src/common/components/LoginPage/LoginPage.js</code>，当 spinnerVisible 为 true 会显示 spinner：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Grid, Row, Col, Image &#125; <span class="keyword">from</span> <span class="string">'react-bootstrap'</span>;</span><br><span class="line"><span class="keyword">import</span> LoginBoxContainer <span class="keyword">from</span> <span class="string">'../../containers/LoginBoxContainer'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> LoginPage = (&#123;</span><br><span class="line">  spinnerVisible,</span><br><span class="line">&#125;) =&gt; (</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;Row className=<span class="string">"show-grid"</span>&gt;</span><br><span class="line">      &lt;Col xs=&#123;<span class="number">6</span>&#125; xsOffset=&#123;<span class="number">3</span>&#125;&gt;</span><br><span class="line">        &lt;LoginBoxContainer /&gt;</span><br><span class="line">        &#123; spinnerVisible === <span class="literal">true</span> ?</span><br><span class="line">          &lt;Image src=<span class="string">"/static/images/loading.gif"</span> /&gt; :</span><br><span class="line">          <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">      &lt;<span class="regexp">/Col&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>Row&gt;</span><br><span class="line">  &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default LoginPage;</span></span><br></pre></td></tr></table></figure>
<p>以下是 <code>src/common/containers/LoginPageContainer/LoginPageContainer.js</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import React from &apos;react&apos;;</span><br><span class="line">import &#123; connect &#125; from &apos;react-redux&apos;;</span><br><span class="line">import LoginPage from &apos;../../components/LoginPage&apos;;</span><br><span class="line"></span><br><span class="line">export default connect(</span><br><span class="line">  (state) =&gt; (&#123;</span><br><span class="line">    spinnerVisible: state.getIn([&apos;ui&apos;, &apos;spinnerVisible&apos;]),</span><br><span class="line">  &#125;),</span><br><span class="line">  (dispatch) =&gt; (&#123;</span><br><span class="line">  &#125;)</span><br><span class="line">)(LoginPage);</span><br></pre></td></tr></table></figure>
<p>真正设计我们内部的食谱， <code>src/common/components/RecipeBox</code>，使用者登入的话可以修改和删除食谱：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Grid, Row, Col, Image, Thumbnail, Button &#125; <span class="keyword">from</span> <span class="string">'react-bootstrap'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> RecipeBox = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span>(</span><br><span class="line">      &lt;Col xs=&#123;<span class="number">6</span>&#125; md=&#123;<span class="number">4</span>&#125;&gt;</span><br><span class="line">        &lt;Thumbnail src=&#123;props.recipe.get(<span class="string">'imagePath'</span>)&#125; alt=<span class="string">"242x200"</span>&gt;</span><br><span class="line">          &lt;h3&gt;&#123;props.recipe.get(<span class="string">'name'</span>)&#125;&lt;<span class="regexp">/h3&gt;</span></span><br><span class="line"><span class="regexp">          &lt;p&gt;&#123;props.recipe.get('description')&#125;&lt;/</span>p&gt;</span><br><span class="line">          &#123;</span><br><span class="line">            props.isAuthorized === <span class="literal">true</span> ? (</span><br><span class="line">            &lt;p&gt;</span><br><span class="line">              &lt;Button bsStyle=<span class="string">"primary"</span> onClick=&#123;props.onDeleteRecipe(props.recipe.get(<span class="string">'_id'</span>))&#125;&gt;删除&lt;<span class="regexp">/Button&gt;&amp;nbsp;</span></span><br><span class="line"><span class="regexp">              &lt;Button bsStyle="default" onClick=&#123;props.onUpadateRecipe(props.recipe.get('_id'))&#125;&gt;修改&lt;/</span>Button&gt;</span><br><span class="line">            &lt;<span class="regexp">/p&gt;)</span></span><br><span class="line"><span class="regexp">            : null            </span></span><br><span class="line"><span class="regexp">          &#125;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>Thumbnail&gt;</span><br><span class="line">      &lt;<span class="regexp">/Col&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default RecipeBox;</span></span><br></pre></td></tr></table></figure>
<p>以下是 <code>src/common/containers/RecipeBoxContainer/RecipeBoxContainer.js</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"><span class="keyword">import</span> RecipeBox <span class="keyword">from</span> <span class="string">'../../components/RecipeBox'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; browserHistory &#125; <span class="keyword">from</span> <span class="string">'react-router'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  deleteRecipe,</span><br><span class="line">  setRecipe,</span><br><span class="line">  setUi</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'../../actions'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(</span><br><span class="line">  (state) =&gt; (&#123;</span><br><span class="line">    isAuthorized: state.getIn([<span class="string">'user'</span>, <span class="string">'isAuthorized'</span>]),</span><br><span class="line">    recipes: state.getIn([<span class="string">'recipe'</span>, <span class="string">'recipes'</span>]),</span><br><span class="line">  &#125;),</span><br><span class="line">  (dispatch) =&gt; (&#123;</span><br><span class="line">    onDeleteRecipe: <span class="function">(<span class="params">recipeId</span>) =&gt;</span> <span class="function"><span class="params">()</span> =&gt;</span> (</span><br><span class="line">      dispatch(deleteRecipe(dispatch, recipeId))</span><br><span class="line">    ),</span><br><span class="line">    onUpadateRecipe: <span class="function">(<span class="params">recipes</span>) =&gt;</span> <span class="function">(<span class="params">recipeId</span>) =&gt;</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> recipeIndex = recipes.findIndex(<span class="function">(<span class="params">_recipe</span>) =&gt;</span> (_recipe.get(<span class="string">'_id'</span>) === recipeId));</span><br><span class="line">      <span class="keyword">const</span> recipe = recipeIndex !== <span class="number">-1</span> ? recipes.get(recipeIndex) : <span class="literal">undefined</span>;</span><br><span class="line">      dispatch(setRecipe(&#123; <span class="attr">keyPath</span>: [<span class="string">'recipe'</span>], <span class="attr">value</span>: recipe &#125;));</span><br><span class="line">      dispatch(setRecipe(&#123; <span class="attr">keyPath</span>: [<span class="string">'recipe'</span>, <span class="string">'id'</span>], <span class="attr">value</span>: recipeId &#125;));</span><br><span class="line">      dispatch(setUi(&#123; <span class="attr">key</span>: <span class="string">'isEdit'</span>, <span class="attr">value</span>: <span class="literal">true</span> &#125;));</span><br><span class="line">      browserHistory.push(<span class="string">'/share?recipeId='</span> + recipeId); </span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;),</span><br><span class="line">  (stateProps, dispatchProps, ownProps) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; recipes &#125; = stateProps; </span><br><span class="line">    <span class="keyword">const</span> &#123; onUpadateRecipe &#125; = dispatchProps; </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.assign(&#123;&#125;, stateProps, dispatchProps, ownProps, &#123;</span><br><span class="line">      onUpadateRecipe: onUpadateRecipe(recipes),</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">)(RecipeBox);</span><br></pre></td></tr></table></figure>
<p>设计我们分享食谱页面，这边我们把编辑食谱和新增分享一起共用了同一个 components，差别在于我们会判断 UI State 中的 <code>isEdit</code>， 决定相应处理方式。在中 <code>src/common/components/ShareBox/ShareBox.js</code>，可以让使用者登入的后修改和删除食谱：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Form, FormGroup, Button, FormControl, ControlLabel &#125; <span class="keyword">from</span> <span class="string">'react-bootstrap'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ShareBox = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (&lt;div&gt;</span><br><span class="line">    &lt;Form horizontal&gt;</span><br><span class="line">      &lt;FormGroup</span><br><span class="line">        controlId="formBasicText"</span><br><span class="line">      &gt;</span><br><span class="line">        &lt;ControlLabel&gt;请输入食谱名称&lt;/ControlLabel&gt;</span><br><span class="line">        &lt;FormControl</span><br><span class="line">          type="text"</span><br><span class="line">          placeholder="Enter text"</span><br><span class="line">          defaultValue=&#123;props.name&#125;</span><br><span class="line">          onChange=&#123;props.onChangeNameInput&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">        &lt;FormControl.Feedback /&gt;</span><br><span class="line">      &lt;/FormGroup&gt;</span><br><span class="line">      &lt;FormGroup</span><br><span class="line">        controlId="formBasicText"</span><br><span class="line">      &gt;</span><br><span class="line">        &lt;ControlLabel&gt;请输入食谱说明&lt;/ControlLabel&gt;</span><br><span class="line">        &lt;FormControl </span><br><span class="line">          componentClass="textarea" </span><br><span class="line">          placeholder="textarea" </span><br><span class="line">          defaultValue=&#123;props.description&#125;          </span><br><span class="line">          onChange=&#123;props.onChangeDescriptionInput&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">        &lt;FormControl.Feedback /&gt;</span><br><span class="line">      &lt;/FormGroup&gt;</span><br><span class="line">      &lt;FormGroup</span><br><span class="line">        controlId="formBasicText"</span><br><span class="line">      &gt;</span><br><span class="line">        &lt;ControlLabel&gt;请输入食谱图片网址&lt;/ControlLabel&gt;</span><br><span class="line">        &lt;FormControl</span><br><span class="line">          type="text"</span><br><span class="line">          placeholder="Enter text"</span><br><span class="line">          defaultValue=&#123;props.imagePath&#125;</span><br><span class="line">          onChange=&#123;props.onChangeImageUrl&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">        &lt;FormControl.Feedback /&gt;</span><br><span class="line">      &lt;/FormGroup&gt;</span><br><span class="line">      &lt;Button </span><br><span class="line">        onClick=&#123;props.onRecipeSubmit&#125; </span><br><span class="line">        bsStyle="success" </span><br><span class="line">        bsSize="large" </span><br><span class="line">        block</span><br><span class="line">      &gt;</span><br><span class="line">        提交送出</span><br><span class="line">      &lt;/Button&gt;</span><br><span class="line">    &lt;/Form&gt;</span><br><span class="line">  &lt;/div&gt;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> ShareBox;</span><br></pre></td></tr></table></figure>
<p>以下是 <code>src/common/containers/ShareBoxContainer/ShareBoxContainer.js</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"><span class="keyword">import</span> ShareBox <span class="keyword">from</span> <span class="string">'../../components/ShareBox'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; </span><br><span class="line">  addRecipe,</span><br><span class="line">  updateRecipe,</span><br><span class="line">  showSpinner,</span><br><span class="line">  setRecipe,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'../../actions'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(</span><br><span class="line">  (state) =&gt; (&#123;</span><br><span class="line">    recipes: state.getIn([<span class="string">'recipe'</span>, <span class="string">'recipes'</span>]),</span><br><span class="line">    recipeId: state.getIn([<span class="string">'recipe'</span>, <span class="string">'recipe'</span>, <span class="string">'id'</span>]),</span><br><span class="line">    name: state.getIn([<span class="string">'recipe'</span>, <span class="string">'recipe'</span>, <span class="string">'name'</span>]),</span><br><span class="line">    description: state.getIn([<span class="string">'recipe'</span>, <span class="string">'recipe'</span>, <span class="string">'description'</span>]),</span><br><span class="line">    imagePath: state.getIn([<span class="string">'recipe'</span>, <span class="string">'recipe'</span>, <span class="string">'imagePath'</span>]),</span><br><span class="line">    isEdit: state.getIn([<span class="string">'ui'</span>, <span class="string">'isEdit'</span>]),</span><br><span class="line">  &#125;),</span><br><span class="line">  (dispatch) =&gt; (&#123;</span><br><span class="line">    onChangeNameInput: <span class="function">(<span class="params">event</span>) =&gt;</span> (</span><br><span class="line">      dispatch(setRecipe(&#123; <span class="attr">keyPath</span>: [<span class="string">'recipe'</span>, <span class="string">'name'</span>], <span class="attr">value</span>: event.target.value &#125;))</span><br><span class="line">    ),</span><br><span class="line">    onChangeDescriptionInput: <span class="function">(<span class="params">event</span>) =&gt;</span> (</span><br><span class="line">      dispatch(setRecipe(&#123; <span class="attr">keyPath</span>: [<span class="string">'recipe'</span>, <span class="string">'description'</span>], <span class="attr">value</span>: event.target.value &#125;))</span><br><span class="line">    ),</span><br><span class="line">    onChangeImageUrl: <span class="function">(<span class="params">event</span>) =&gt;</span> (</span><br><span class="line">      dispatch(setRecipe(&#123; <span class="attr">keyPath</span>: [<span class="string">'recipe'</span>, <span class="string">'imagePath'</span>], <span class="attr">value</span>: event.target.value &#125;))</span><br><span class="line">    ),    </span><br><span class="line">    onRecipeSubmit: <span class="function">(<span class="params">recipes, recipeId, name, description, imagePath, isEdit</span>) =&gt;</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (isEdit === <span class="literal">true</span>) &#123;</span><br><span class="line">        dispatch(updateRecipe(dispatch, recipeId, name, description, imagePath));</span><br><span class="line">        dispatch(showSpinner());</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dispatch(addRecipe(dispatch, name, description, imagePath));</span><br><span class="line">        dispatch(showSpinner());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,    </span><br><span class="line">  &#125;),</span><br><span class="line">  (stateProps, dispatchProps, ownProps) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; recipes, recipeId, name, description, imagePath, isEdit &#125; = stateProps;</span><br><span class="line">    <span class="keyword">const</span> &#123; onRecipeSubmit &#125; = dispatchProps;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.assign(&#123;&#125;, stateProps, dispatchProps, ownProps, &#123;</span><br><span class="line">      onRecipeSubmit: onRecipeSubmit(recipes, recipeId, name, description, imagePath, isEdit),</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;  </span><br><span class="line">)(ShareBox);</span><br></pre></td></tr></table></figure>
<p>单纯的 SharePage（<code>src/common/components/SharePage/SharePage.js</code>）页面：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Grid, Row, Col &#125; <span class="keyword">from</span> <span class="string">'react-bootstrap'</span>;</span><br><span class="line"><span class="keyword">import</span> ShareBoxContainer <span class="keyword">from</span> <span class="string">'../../containers/ShareBoxContainer'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> SharePage = <span class="function"><span class="params">()</span> =&gt;</span> (</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;Row className=<span class="string">"show-grid"</span>&gt;</span><br><span class="line">      &lt;Col xs=&#123;<span class="number">6</span>&#125; xsOffset=&#123;<span class="number">3</span>&#125;&gt;</span><br><span class="line">        &lt;ShareBoxContainer /&gt;</span><br><span class="line">      &lt;<span class="regexp">/Col&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>Row&gt;</span><br><span class="line">  &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default SharePage;</span></span><br></pre></td></tr></table></figure>
<p>以下是 <code>src/common/containers/SharePageContainer/SharePageContainer.js</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"><span class="keyword">import</span> SharePage <span class="keyword">from</span> <span class="string">'../../components/SharePage'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(</span><br><span class="line">  (state) =&gt; (&#123;</span><br><span class="line">  &#125;),</span><br><span class="line">  (dispatch) =&gt; (&#123;</span><br><span class="line">  &#125;)</span><br><span class="line">)(SharePage);</span><br></pre></td></tr></table></figure>
<p>恭喜你成功抵达终点！若一切顺利，在终端机打上 <code>$ npm start</code>，你将可以在浏览器的 <code>http://localhost:3000</code> 看到自己的成果！</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章整合过去所学和添加一些后端资料库知识开发了一个可以登入会员并分享食谱的社群网站！快把你的成果和你的朋友分享吧！觉得意犹未尽？别忘了附录也很精采！最后，再次谢谢读者们支持我们一路走完了 React 开发学习之旅！然而前端技术变化很快，唯有不断自我学习才能持续成长。笔者才疏学浅，撰写学习心得或有疏漏，若有任何建议或提醒都欢迎和我说，大家一起加油：）</p>
<h2 id="延伸阅读"><a href="#延伸阅读" class="headerlink" title="延伸阅读"></a>延伸阅读</h2><ol>
<li><a href="https://github.com/joshgeller/react-redux-jwt-auth-example" target="_blank" rel="noopener">joshgeller/react-redux-jwt-auth-example</a></li>
<li><a href="https://medium.com/@rajaraodv/securing-react-redux-apps-with-jwt-tokens-fcfe81356ea0#.5hfri5j5m" target="_blank" rel="noopener">Securing React Redux Apps With JWT Tokens</a></li>
<li><a href="https://auth0.com/blog/adding-authentication-to-react-native-using-jwt/" target="_blank" rel="noopener">Adding Authentication to Your React Native App Using JSON Web Tokens</a></li>
<li><a href="http://vladimirponomarev.com/blog/authentication-in-react-apps-jwt" target="_blank" rel="noopener">Authentication in React Applications, Part 2: JSON Web Token (JWT)</a></li>
<li><a href="https://nodejust.com/nodejs-passport-auth-tutorial/" target="_blank" rel="noopener">Node.js 身份认证：Passport 入门</a></li>
<li><a href="https://github.com/reactjs/react-router/issues/83" target="_blank" rel="noopener">react-bootstrap compatibility #83</a></li>
<li><a href="https://github.com/reactjs/react-router/issues/725" target="_blank" rel="noopener">How to authenticate routes using Passport? #725</a></li>
<li><a href="https://github.com/tech-dojo/react-showcase" target="_blank" rel="noopener">Isomorphic React Web App Demo with Material UI</a></li>
<li><a href="https://github.com/reactjs/react-router/tree/master/examples/auth-flow" target="_blank" rel="noopener">react-router/examples/auth-flow/</a></li>
<li><a href="https://github.com/acdlite/redux-promise" target="_blank" rel="noopener">redux-promise</a></li>
<li><a href="http://qiita.com/takaki@github/items/42bddf01d36dc18bdc8e" target="_blank" rel="noopener">How to use redux-promise</a></li>
<li><a href="https://scotch.io/tutorials/authenticate-a-node-js-api-with-json-web-tokens" target="_blank" rel="noopener">Authenticate a Node.js API with JSON Web Tokens</a></li>
<li><a href="https://www.sitepoint.com/3-javascript-orms-you-might-not-know/" target="_blank" rel="noopener">3 JavaScript ORMs You Might Not Know</a></li>
<li><a href="https://github.com/lynndylanhurley/redux-auth" target="_blank" rel="noopener">lynndylanhurley/redux-auth</a></li>
<li><a href="http://stackoverflow.com/questions/33724396/how-to-avoid-getting-error-localstorage-is-not-defined-on-server-in-reactjs-is" target="_blank" rel="noopener">How to avoid getting error ‘localStorage is not defined’ on server in ReactJS isomorphic app?</a></li>
<li><a href="https://stormpath.com/blog/where-to-store-your-jwts-cookies-vs-html5-web-storage" target="_blank" rel="noopener">Where to Store your JWTs – Cookies vs HTML5 Web Storage</a></li>
<li><a href="http://stackoverflow.com/questions/6922145/what-is-the-difference-between-server-side-cookie-and-client-side-cookie" target="_blank" rel="noopener">What is the difference between server side cookie and client side cookie? [closed]</a></li>
<li><a href="https://auth0.com/blog/angularjs-authentication-with-cookies-vs-token/" target="_blank" rel="noopener">Cookies vs Tokens. Getting auth right with Angular.JS</a></li>
<li><a href="https://auth0.com/blog/cookies-vs-tokens-definitive-guide/" target="_blank" rel="noopener">Cookies vs Tokens: The Definitive Guide</a></li>
<li><a href="https://github.com/joshgeller/react-redux-jwt-auth-example" target="_blank" rel="noopener">joshgeller/react-redux-jwt-auth-example</a></li>
<li><a href="http://stackoverflow.com/questions/31079081/programmatically-navigate-using-react-router" target="_blank" rel="noopener">Programmatically navigate using react router</a></li>
<li><a href="https://github.com/reactjs/react-router/blob/master/upgrade-guides/v2.4.0.md" target="_blank" rel="noopener">withRouter HoC (higher-order component) v2.4.0 Upgrade Guide</a></li>
</ol>
<h2 id="License"><a href="#License" class="headerlink" title="License"></a>License</h2><p>MIT, Special thanks <a href="http://loading.io/" target="_blank" rel="noopener">Loading.io</a></p>

                <div style="margin-top:15px;">
                   <hr class="nogutter">
                   <h3>^-^欢迎回复交流^-^</h3>
                    <div id="comment" class='cloudcomment'></div>
                </div>
            </div>
            <div class="clearfix"></div>
            <hr class="nogutter">
            <div class="bshare-custom" style="float: right;margin-bottom: 10px">
                <div class="bsPromo bsPromo2"></div>
                <a title="分享到微信" class="bshare-weixin" href="javascript:void(0);"></a>
                <a title="分享到新浪微博" class="bshare-sinaminiblog" href="javascript:void(0);"></a>
                <a title="分享到QQ空间" class="bshare-qzone"></a>
                <a title="分享到人人网" class="bshare-renren"></a>
                <a title="分享到腾讯微博" class="bshare-qqmb"></a>
                <a title="更多平台" class="bshare-more bshare-more-icon more-style-addthis"></a>
                <span class="BSHARE_COUNT bshare-share-count" style="float: none;">0</span></div>
            <div class="dashang">
                <div class="title">赏点咖啡钱^.^</div>
                <img src="/img/wchat.jpeg"/><img src="/img/zhifubao.png"/>
            </div>
            <div style="display: none;" id="rocket-to-top">
                <div style="opacity:0.3;display: block;" class="level-2"></div>
                <div class="level-3"></div>
            </div>
        </div>
        <nav class="pagination" role="pagination">
    
    <a class="pull-left" href="/kettle/kettle4.html" style="float: left;">
        ← kettle实现异构数据同步(四)
    </a>
    
    
    <a class="pull-right" href="/nodejs/nodepost64file.html">
        node保存base64编码的图片 →
    </a>
    
</nav>

    </div>
</section>

<div id="qMenu" class="qmenu">
    <div class="sb-close" aria-label="Close Menu" aria-hidden="true" onclick="javacript:void(0);$('#qMenu').hide();">
        <img src="/img/close.png" alt="Close">
    </div>
</div>
<script type="text/javascript" charset="utf-8"
        src="http://static.bshare.cn/b/buttonLite.js#style=-1&amp;uuid=&amp;pophcol=2&amp;lang=zh"></script>
<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/bshareC0.js"></script>
<script src="../../js/av-min.js"></script>
<script src="../../js/Valine.min.js"></script>
<script src=''></script>
<script type="text/javascript">
    //// 小火箭
    $(function () {
        var e = $("#rocket-to-top"),
                t = $(document).scrollTop(),
                n,
                r,
                i = !0;
        $(window).scroll(function () {
            var t = $(document).scrollTop();
            t == 0 ? e.css("background-position") == "0px 0px" ? e.fadeOut("slow") : i && (i = !1, $(".level-2").css("opacity", 1), e.delay(100).animate({
                        marginTop: "-1000px"
                    },
                    "normal",
                    function () {
                        e.css({
                            "margin-top": "-125px",
                            display: "none"
                        }),
                                i = !0
                    })) : e.fadeIn("slow")
        }),
                e.hover(function () {
                            $(".level-2").stop(!0).animate({
                                opacity: 1
                            })
                        },
                        function () {
                            $(".level-2").stop(!0).animate({
                                opacity: 0
                            })
                        }),
                $(".level-3").click(function () {
                    function t() {
                        var t = e.css("background-position");
                        if (e.css("display") == "none" || i == 0) {
                            clearInterval(n),
                                    e.css("background-position", "0px 0px");
                            return
                        }
                        switch (t) {
                            case "0px 0px":
                                e.css("background-position", "-298px 0px");
                                break;
                            case "-298px 0px":
                                e.css("background-position", "-447px 0px");
                                break;
                            case "-447px 0px":
                                e.css("background-position", "-596px 0px");
                                break;
                            case "-596px 0px":
                                e.css("background-position", "-745px 0px");
                                break;
                            case "-745px 0px":
                                e.css("background-position", "-298px 0px");
                        }
                    }

                    if (!i) return;
                    n = setInterval(t, 50),
                            $("html,body").animate({scrollTop: 0}, "slow");
                });
    });


    //// a 标签新页面打开
    $("#content a").each(function () {
        $(this).attr('target','_blank');
        $(this).attr('style','color:#203ada;');
    })

</script>
<script type="text/javascript">
    new Valine({
        el: '#comment' ,
        notify:false, 
        verify:false,   
        appId: 'Uxwf2V456s7ppITYyLu7dgLo-gzGzoHsz',
        appKey: 'Itbf11QmS5FNnX7UzEy72OQe',
        placeholder: 'just go go',
        path:window.location.pathname, 
        avatar:'mm' 
    });
    //// 生成目录
    function go(title) {
        var top = $("#" + title).offset().top;
        $(document).scrollTop(top - 60);
    }
    ;
    var system = {
        win: false,
        mac: false,
        xll: false,
        ipad: false
    };
    //检测平台
    var p = navigator.platform;
    system.win = p.indexOf("Win") == 0;
    system.mac = p.indexOf("Mac") == 0;
    system.x11 = (p == "X11") || (p.indexOf("Linux") == 0);
    system.ipad = (navigator.userAgent.match(/iPad/i) != null) ? true : false;
    if ((system.win || system.mac || system.xll || system.ipad)) {
        //document.writeln('PC')
        $(function () {
            var qMenu = '';
            var title = '';
            var obj;
            $('#content').find('h2').each(function (index, item) {
                obj = $(this).find('a.headerlink').eq(0);
                title = obj.attr('title');
                qMenu += '<div class="contenttitle" data="title" onclick="go(\'' + title + '\')">' + index + '、' + title + '</div>';
            })
            if (qMenu.length > 0) {
                qMenu = ' <div><span>目录</span>' + qMenu + '</div>';
                $('#qMenu').append($(qMenu));
            }else {
                $('#qMenu').remove();
            }
        });
    } else {
        $('#qMenu').remove();
    }
</script>

<!-- ============================ Footer =========================== -->

<footer>
    <div class="container">
        <div class="copy">
            <p>
                &copy; 2017
                <script>new Date().getFullYear() > 2010 && document.write("-" + new Date().getFullYear());</script>
                , Content By ustbtaotao. All Rights Reserved.
            </p>
            <p>welcome to U &nbsp;&nbsp;&nbsp;&nbsp;i咖啡小屋里的咖啡被品尝<span style="color: red" id="totalcount">--</span>次</p>
            <div class="guanzhu">
                <div class="weixin">
                    <span>关注微信</span>
                    <img src="/img/weixin.jpg"/>
                </div>
                <div class="weibo">
                    <span>关注微博</span>
                    <img src="/img/weibo.png"/>
                </div>
            </div>
        </div>
        <div class="social">
            <ul>
                
                
                
                
                
                <li><a href="http://weibo.com/ustbtaotao" title="Sina-Weibo" target="_blank"><i class="icon-sina-weibo"></i></a>&nbsp;
                </li>
                
            </ul>
        </div>
        <div class="clearfix"></div>
    </div>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?16ff0b4e8ca51c0734eb447a23473b9f";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?65e3e0b08038c3bdc07ecf223a4ae231";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

</footer>

<!-- ============================ END Footer =========================== -->
<!-- Load our scripts -->
<!-- Resizable 'on-demand' full-height hero -->
<script type="text/javascript">
    var resizeHero = function () {
        var hero = $(".cover,.heightblock"),
                window1 = $(window);
        hero.css({
            "height": window1.height() - 300
        });
    };

    resizeHero();

    $(window).resize(function () {
        resizeHero();
    });
</script>
<script src="/js/plugins.min.js"></script><!-- Bootstrap core and concatenated plugins always load here -->
<script src="/js/jquery.flexslider-min.js"></script><!-- Flexslider plugin -->
<script src="/js/scripts.js"></script><!-- Theme scripts -->


<script src="/js/search.js"></script>
<script src="/js/jquery.fancybox-1.3.1.pack.js"></script>
<script type="text/javascript">
    $('#intro').find('img').each(function () {
        var alt = this.alt;

        if (alt) {
            $(this).after('<span class="caption" style="display:none">' + alt + '</span>');
        }

        $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="gallery" />');
    });
    jQuery(document).ready(function () {
        jQuery('.fancybox').fancybox();
    })
</script>

<!-- Initiate flexslider plugin -->
<script type="text/javascript">
    $(document).ready(function ($) {
        (function () {
            console.log('font');
            var getCss = function (path) {
                var head = document.getElementsByTagName('head')[0];
                link = document.createElement('link');
                link.href = path;
                link.rel = 'stylesheet';
                link.type = 'text/css';
                head.appendChild(link);
            };
            getCss('https://fonts.googleapis.com/css?family=Montserrat:400,700');
            getCss('https://fonts.googleapis.com/css?family=Open+Sans:400,600');
        })();
        $('.flexslider').flexslider({
            animation: "fade",
            prevText: "",
            nextText: "",
            directionNav: true
        });
    });
</script>


<script type="text/javascript">
    var search_path = "db.json";
    if (search_path.length == 0) {
        search_path = "search.xml";
    }
    var path = "/" + search_path;
    $("#local-search-input").keydown(function (event) {
        if (event.keyCode == "13") {//keyCode=13是回车键
            searchFunc(path, 'local-search-input', 'local-search-result');
        }
    });
    $("#local-search-input").keyup(function (event) {
        searchFunc(path, 'local-search-input', 'local-search-result');
    });
    $("#navigation").click(function () {
        $("#local-search-result").html('');
        $("#local-search-result").hide();
        $("#local-search-input").val('');
    })
</script>


<!--统计-->
<script src="//cdn1.lncld.net/static/js/2.5.0/av-min.js"></script>
<script>
    var APP_ID = 'Uxwf2V456s7ppITYyLu7dgLo-gzGzoHsz';
    var APP_KEY = 'Itbf11QmS5FNnX7UzEy72OQe';
    AV.init({
        appId: APP_ID,
        appKey: APP_KEY
    });
    function showTime(Counter) {
        var query = new AV.Query("Counter");
        if ($(".leancloud_visitors").length > 0) {
            var url = $(".leancloud_visitors").attr('id').trim();
            var postdate = $(".leancloud_visitors").attr('data_time').trim();
            var time = new Date(postdate).getTime();
            var init = 99;
            if (time + 7 * 24 * 3600 * 1000 > new Date().getTime()) {
                init = 1;
            }
            query.equalTo("words", url);
            query.count().then(function (number) {
                // There are number instances of MyClass.
                $(document.getElementById(url)).text(number && !isNaN(number) ? init + number : '--');
            }, function (error) {
                // error is an instance of AVError.
            });
        }
        query = new AV.Query("Counter");
        query.count().then(function (number) {
            // There are number instances of MyClass.
            $(document.getElementById('totalcount')).text(number && !isNaN(number) ? 2220 + number : '--');
        }, function (error) {
            // error is an instance of AVError.
        });
    }

    function addCount(Counter) {
        var url = $(".leancloud_visitors").length > 0 ? $(".leancloud_visitors").attr('id').trim() : 'icafebolger.com';
        var Counter = AV.Object.extend("Counter");
        var query = new Counter;
        query.save({
            words: url
        }).then(function (object) {

        })
    }
    $(function () {
        var Counter = AV.Object.extend("Counter");
        addCount(Counter);
        showTime(Counter);
    });
</script>
</body>
</html>
